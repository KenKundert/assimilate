# Assimilate tests

assimilate:

    initialize — check initial config directory creation {{{1:
        initialization:
        tests:
            foamy — create config dir and check its contents {{{2:
                run: assimilate
                checks:
                    stdout:
                        matches text:
                            > Configuration directory created:
                            >     /{run_dir}/.config/assimilate
                            > Includes example settings files. Edit them to suit your needs.
                            > Search for and replace any fields delimited with ⟪ and ⟫.
                            > Delete any configurations you do not need.

                    ~/.config/assimilate/shared.conf.nt:
                        contains lines in order:
                            > default config: ⟪default-config⟫
                            > composite configs: ⟪composite-configs⟫
                            > default mount point: ~/ASSIMILATE
                            > notify: ⟪your-email-address⟫
                            > notifier: notify-send -u normal {{prog_name}} "{{msg}}"
                            > prune after create: 'yes
                            > check after create: 'latest
                            > compact after delete: 'yes
                            > exclude if present: .nobackup
                            > exclude caches: 'yes
                            > exclude nodump: 'yes
                            > command aliases:
                            >     repo-list:
                            >         - archives
                            >         - recent --last=20
                            >     list: paths
                            > logging:
                            >     keep for: 1w
                            >     max entries: 20
                            > list formats:
                            >     name: {{path}}
                            >     short: {{path}}{{Type}}
                            >     date: {{MTime:ddd YYYY-MM-DD HH:mm:ss}} {{path}}{{Type}}
                            >     size: {{size:8}} {{path}}{{Type}}
                            >     si: {{Size:7.2b}} {{path}}{{Type}}
                            >     owner: {{user:8}} {{path}}{{Type}}
                            >     group: {{group:8}} {{path}}{{Type}}
                            >     long: {{mode:10}} {{user:6}} {{group:6}} {{size:8}} {{mtime}} {{path}}{{extra}}
                            > default list format: short

                    ~/.config/assimilate/root.conf.nt:
                        contains lines in order:
                            > repository: ⟪host⟫:⟪path⟫/{{host_name}}-{{user_name}}-{{config_name}}
                            > archive: {{host_name}}-{{{{now}}}}
                            > encryption: ⟪encryption⟫
                            > passphrase: ⟪passcode⟫
                            > pass command: ⟪command⟫
                            >     - R /etc
                            >     - R /home
                            >     - R /root
                            >     - R /var
                            >     - R /srv
                            >     - R /opt
                            >     - R /usr/local
                            >     - - /var/cache
                            >     - - /var/lock
                            >     - - /var/run
                            >     - - /var/tmp
                            >     - - /root/.cache
                            >     - - /home/*/.cache
                            > keep within: 1d
                            > keep daily: 7
                            > keep weekly: 4
                            > keep monthly: 6

                    ~/.config/assimilate/home.conf.nt:
                        contains lines in order:
                            > repository: ⟪host⟫:⟪path⟫/{{host_name}}-{{user_name}}-{{config_name}}
                            > archive: {{config_name}}-{{{{now}}}}
                            > encryption: ⟪encryption⟫
                            > passphrase: ⟪passcode⟫
                            > pass command: ⟪command⟫
                            > patterns:
                            >     - R ~
                            >     - - ~/.cache
                            >     - - **/*~
                            >     - - **/__pycache__
                            >     - - **/*.pyc
                            >     - - **/.*.swp
                            >     - - **/.*.swo
                            > keep within: 1d
                            > keep daily: 7
                            > keep weekly: 4
                            > keep monthly: 6

                    ~/.config/assimilate/cache.conf.nt:
                        contains lines in order:
                            > repository: ~/.cache/backups
                            > archive: {{config_name}}-{{{{now}}}}
                            > encryption: none
                            > patterns:
                            >     - R ~
                            >     - - ~/music
                            >     - - ~/videos
                            >     - - ~/photos
                            >     - - ~/.cache
                            >     - - **/*~
                            >     - - **/__pycache__
                            >     - - **/*.pyc
                            >     - - **/.*.swp
                            >     - - **/.*.swo
                            > keep within: 1d
                            > keep hourly: 48

    druid — single config that uses patterns, explicit archive, and basic settings {{{1:
        initialization:
            create:
                ~/.config/assimilate/shared.conf.nt:
                    contents:
                        > encryption: none

                ~/REPO/:

                ~/.config/assimilate/test.conf.nt:
                    contents:
                        > repository: ~/REPO/{config_name}
                        > patterns:
                        >     - R ~
                        >     - - ~/.cache
                        >     - - ~/.local
                        >     - - ~/bu
                        >     - - ~/REPO

                ~/a:
                    contents:
                        > aaa
                    mtime: 2024-11-27

                ~/b:
                    contents:
                        > bbb
                    mtime: 2024-11-26

        tests:
            catacomb — version {{{2:
                run: assimilate version
                checks:
                    stdout:
                        matches regex: assimilate version: \d+\.\d+(\.\d+)?(\.?\w+\d+)?  \(\d\d\d\d-\d\d-\d\d\) \[Python \d\.\d+\.\d+\]\.

            vignette — help {{{2:
                run: assimilate help
                checks:
                    stdout:
                        matches text:
                            > Assimilate Backups
                            >
                            > Backs up the contents of a file hierarchy.  A front end for Borg's
                            > encrypted incremental backup utility.
                            >
                            > Usage:
                            >     assimilate [options] [<command> [<args>...]]
                            >
                            > Options:
                            >     -c <cfgname>, --config <cfgname>  Specifies the configuration to use.
                            >     -d, --dry-run                     Run Borg in dry run mode.
                            >     -h, --help                        Output basic usage information.
                            >     -m, --mute                        Suppress all output.
                            >     -n, --narrate                     Send Assimilate and Borg narration to stdout.
                            >     -q, --quiet                       Suppress optional output.
                            >     -r, --relocated                   Acknowledge that repository was relocated.
                            >     -v, --verbose                     Make Borg more verbose.
                            >     --no-log                          Do not create log file.
                            >
                            > Available commands:
                            >     borg              run a raw borg command
                            >     break-lock        breaks the repository and cache locks
                            >     check             checks the repository and its archives
                            >     compact           compact segment files in the repository
                            >     compare           compare local files or directories to those in an archive
                            >     configs           list available backup configurations
                            >     create            create an archive of the current files
                            >     delete            delete an archive currently contained in the repository
                            >     diff              show the differences between two archives
                            >     due               days since last backup
                            >     extract           recover file or files from archive
                            >     help              give information about commands or other topics
                            >     info              display metadata for a repository or archive
                            >     list              list the files contained in an archive
                            >     log               display log for the last assimilate run
                            >     mount             mount a repository or archive
                            >     overdue           show status of known repositories
                            >     prune             prune the repository of excess archives
                            >     repo-create       initialize the repository
                            >     repo-list         display available archives
                            >     repo-space        manage the amount of space kept in reserve
                            >     restore           restore requested files or directories in place
                            >     settings, setting
                            >                       display settings of chosen configuration
                            >     umount            un-mount a previously mounted repository or archive
                            >     undelete          remove deletion marker from selected archives
                            >     version           display assimilate version
                            >
                            > Available topics:
                            >     overview          overview of assimilate
                            >     precautions       what everybody should know before using assimilate

            convince — help borg {{{2:
                run: assimilate help borg
                checks:
                    stdout:
                        matches text:
                            > Run a Raw Borg Command.
                            >
                            > Usage:
                            >     assimilate borg <borg_args>...
                            >
                            > You can specify the repository to act on using “@repo”, which is
                            > replaced with the path to the repository.  The passphrase is set before
                            > the command is run.
                            >
                            > Be aware that the Borg is run from ‘working_dir’ (default is /), and
                            > so any relative paths given as command line arguments are relative to
                            > ‘working_dir’.

            binding — repo-create {{{2:
                run: assimilate repo-create
                checks:
                    stdout:
                        contains text: Reserve some repository storage space now for emergencies

                    ~/.local/share/assimilate/test.log:
                        contains text:
                            > running:
                            >     borg \
                            >         repo-create \
                            >         --repo=/{run_dir}/REPO/test \
                            >         --make-parent-dirs \
                            >         --encryption=none

                    ~/.local/share/assimilate/test.log.nt:
                        contains lines in order:
                            -     > running:
                            -     >     borg \
                            -     >         repo-create \
                            -     >         --repo=/{run_dir}/REPO/test \
                            -     >         --make-parent-dirs \
                            -     >         --encryption=none

            putter — create {{{2:
                run: assimilate create
                checks:
                    ~/.local/share/assimilate/test.log:
                        contains text:
                            > running:
                            >     borg \
                            >         create \
                            >         --repo=/{run_dir}/REPO/test \
                            >         '--pattern=R /{run_dir}' \
                            >         '--pattern=- /{run_dir}/.cache' \
                            >         '--pattern=- /{run_dir}/.local' \
                            >         '--pattern=- /{run_dir}/bu' \
                            >         '--pattern=- /{run_dir}/REPO' \
                            >         --stats \
                            >         '{hostname}-{username}-test-{{now}}'

                    ~/.local/share/assimilate/test.log.nt:
                        contains lines in order:
                            >     > running:
                            >     >     borg \
                            >     >         create \
                            >     >         --repo=/{run_dir}/REPO/test \
                            >     >         '--pattern=R /{run_dir}' \
                            >     >         '--pattern=- /{run_dir}/.cache' \
                            >     >         '--pattern=- /{run_dir}/.local' \
                            >     >         '--pattern=- /{run_dir}/bu' \
                            >     >         '--pattern=- /{run_dir}/REPO' \
                            >     >         --stats \
                            >     >         '{hostname}-{username}-test-{{now}}'

                    ~/.local/share/assimilate/test.latest.nt:
                        contains regex: ^create last run: \d\d\d\d-\d\d-\d\dT\d\d:\d\d:\d\d.*$

            aitch — list --show-formats {{{2:
                run: assimilate list --show-formats
                checks:
                    stdout:
                        matches text:
                            >      name: {{path}}
                            >     short: {{path}}{{Type}}
                            >      date: {{mtime}} {{path}}{{Type}}
                            >      size: {{size:8}} {{path}}{{Type}}
                            >        si: {{Size:7.2b}} {{path}}{{Type}}
                            >     owner: {{user:8}} {{path}}{{Type}}
                            >     group: {{group:8}} {{path}}{{Type}}
                            >      long: {{mode:10}} {{user:6}} {{group:6}} {{size:8}} {{mtime}} {{path}}{{extra}}
                            >
                            > default format: short

            oxcart — create again {{{2:
                run: assimilate
                checks:
                    ~/.local/share/assimilate/test.log:
                        contains text:
                            > running:
                            >     borg \
                            >         create \
                            >         --repo=/{run_dir}/REPO/test \
                            >         '--pattern=R /{run_dir}' \
                            >         '--pattern=- /{run_dir}/.cache' \
                            >         '--pattern=- /{run_dir}/.local' \
                            >         '--pattern=- /{run_dir}/bu' \
                            >         '--pattern=- /{run_dir}/REPO' \
                            >         --stats \
                            >         '{hostname}-{username}-test-{{now}}'

                    ~/.local/share/assimilate/test.log.nt:
                        contains text:
                            >     > running:
                            >     >     borg \
                            >     >         create \
                            >     >         --repo=/{run_dir}/REPO/test \
                            >     >         '--pattern=R /{run_dir}' \
                            >     >         '--pattern=- /{run_dir}/.cache' \
                            >     >         '--pattern=- /{run_dir}/.local' \
                            >     >         '--pattern=- /{run_dir}/bu' \
                            >     >         '--pattern=- /{run_dir}/REPO' \
                            >     >         --stats \
                            >     >         '{hostname}-{username}-test-{{now}}'

                    ~/.local/share/assimilate/test.latest.nt:
                        contains regex: ^create last run: \d\d\d\d-\d\d-\d\dT\d\d:\d\d:\d\d.*$

            expiate — repo-list with --relocated {{{2:
                run: assimilate --relocated repo-list
                checks:
                    stdout:
                        matches regex:
                            > 1   aid:(?P<aid1>\w+)  (?P<ar1>[^ ]+)   .*
                            > 0   aid:(?P<aid0>\w+)  (?P<ar0>[^ ]+)   .*

                    ~/.local/share/assimilate/test.log:
                        contains text:
                            > Borg-related environment variables: {{
                            >     'BORG_RELOCATED_REPO_ACCESS_IS_OK': 'YES',
                            > }}

                        contains text:
                            > running:
                            >     borg \
                            >         repo-list \
                            >         --json \
                            >         --repo=/{run_dir}/REPO/test \
                            >         '--match-archives=sh:{hostname}-{username}-test-*'

                    ~/.local/share/assimilate/test.log.nt:
                        contains text:
                            >     > Borg-related environment variables: {{
                            >     >     'BORG_RELOCATED_REPO_ACCESS_IS_OK': 'YES',
                            >     > }}

                        contains text:
                            >     > running:
                            >     >     borg \
                            >     >         repo-list \
                            >     >         --json \
                            >     >         --repo=/{run_dir}/REPO/test \
                            >     >         '--match-archives=sh:{hostname}-{username}-test-*'

            ampere — delete {{{2:
                run: assimilate delete -a {ar1}
                checks:
                    stdout:
                        matches regex:
                            > Done. Run "borg compact" to free space.
                            >

                    ~/.local/share/assimilate/test.log:
                        contains regex:
                            > running:
                            >     borg \\
                            >         delete \\
                            >         --match-archives={hostname}-{username}-test-.* \\
                            >         --repo=/{run_dir}/REPO/test
                        excludes line: running command: compact

            bristly — repo-list {{{2:
                run: assimilate repo-list
                checks:
                    stdout:
                        matches regex:
                            > 0   aid:(?P<aid0>\w+)  (?P<ar0>[^ ]+)   .*

            prodigy — repo-list --deleted {{{2:
                run: assimilate repo-list --deleted
                checks:
                    stdout:
                        matches regex:
                            > aid:(?P<aid1>\w+)  (?P<ar1>[^ ]+)   .*

            ascend — undelete {{{2:
                run: assimilate undelete -a {ar1}
                checks:
                    stdout:
                        matches regex:
                            > Done.

            ground — repo-list {{{2:
                run: assimilate repo-list
                checks:
                    stdout:
                        matches regex:
                            > 1   aid:(?P<aid1>\w+)  (?P<ar1>[^ ]+)   .*
                            > 0   aid:(?P<aid0>\w+)  (?P<ar0>[^ ]+)   .*

            informer — list {{{2:
                run: assimilate list
                checks:
                    stdout:
                        contains lines:
                            - {run_dir}/
                            - {run_dir}/.config/
                            - {run_dir}/.config/assimilate/
                            - {run_dir}/.config/assimilate/shared.conf.nt
                            - {run_dir}/.config/assimilate/test.conf.nt
                            - {run_dir}/a
                            - {run_dir}/b

                    stderr:
                        matches regex:
                            > archive: {aid0} {ar0} .*

                    ~/.local/share/assimilate/test.log:
                        contains text:
                            > running:
                            >     borg \
                            >         repo-list \
                            >         --repo=/{run_dir}/REPO/test \
                            >         '--match-archives=sh:{hostname}-{username}-test-*' \
                            >         --json \
                            >         --last=1
                        contains regex:
                            > running:
                            >     borg \\
                            >         list \\
                            >         --repo=/{run_dir}/REPO/test \\
                            >         --json-lines \\
                            >         '--format={{path}}{{type}}' \\
                            >         aid:{aid0}[a-f0-9]+$

                    ~/.local/share/assimilate/test.log.nt:
                        contains lines in order:
                            -     > running command: list
                            -

            provider — break-lock {{{2:
                # there is no lock to break, but exercise the command anyway
                run: assimilate break-lock
                checks:
                    ~/.local/share/assimilate/test.log:
                        contains text:
                            > running:
                            >     borg \
                            >         break-lock \
                            >         --repo=/{run_dir}/REPO/test

                    ~/.local/share/assimilate/test.log.nt:
                        contains text:
                            >     > running:
                            >     >     borg \
                            >     >         break-lock \
                            >     >         --repo=/{run_dir}/REPO/test

            rafter — prune :
                run: assimilate prune
                checks:
                    stderr:
                        matches text:
                            > assimilate error: No prune settings available.
                            >     At least one of keep_within, keep_last, keep_minutely, keep_hourly,
                            >     keep_daily, keep_weekly, keep_monthly, or keep_yearly must be
                            >     specified.
                    status: 2

            felony — compact {{{2:
                run: assimilate compact
                checks:
                    ~/.local/share/assimilate/test.log:
                        contains text:
                            > running:
                            >     borg \
                            >         compact \
                            >         --repo=/{run_dir}/REPO/test

                    ~/.local/share/assimilate/test.log.nt:
                        contains text:
                            >     > running:
                            >     >     borg \
                            >     >         compact \
                            >     >         --repo=/{run_dir}/REPO/test

                    ~/.local/share/assimilate/test.latest.nt:
                        contains regex: ^compact last run: \d\d\d\d-\d\d-\d\dT\d\d:\d\d:\d\d.*$


            pullet — check {{{2:
                run: assimilate check
                checks:
                    ~/.local/share/assimilate/test.log:
                        contains text:
                            > running:
                            >     borg \
                            >         check \
                            >         --last=1 \
                            >         --repo=/{run_dir}/REPO/test \
                            >         '--match-archives=sh:{hostname}-{username}-test-*'

                    ~/.local/share/assimilate/test.log.nt:
                        contains text:
                            >     > running:
                            >     >     borg \
                            >     >         check \
                            >     >         --last=1 \
                            >     >         --repo=/{run_dir}/REPO/test \
                            >     >         '--match-archives=sh:{hostname}-{username}-test-*'

                    ~/.local/share/assimilate/test.latest.nt:
                        contains regex: ^check last run: \d\d\d\d-\d\d-\d\dT\d\d:\d\d:\d\d.*$


            fitting — compare {{{2:
                run: assimilate compare
                checks:
                    stderr:
                        matches text: assimilate error: must specify default_mount_point setting to use this command.
                    status: 2

            salesman — configs {{{2:
                run: assimilate configs
                checks:
                    stdout:
                        matches text:
                            > Available Configurations:
                            >     test
                            >
                            > No default configuration available.

            fireguard — overdue {{{2:
                run: assimilate overdue
                checks:
                    stderr:
                        matches text:
                            > assimilate error:
                            >     /{run_dir}/.config/assimilate/overdue.conf.nt: no such file or directory.
                    status: 2

            profile — settings {{{2:
                run: assimilate settings
                checks:
                    stdout:
                        matches regex:
                            >                    archive: {{host_name}}-{{user_name}}-{{config_name}}-{{{{now}}}}
                            >            ❬when resolved❭: .+-.+-test-{{now}}
                            >                   cmd_name: settings
                            >                 config_dir: /{run_dir}/\.config/assimilate
                            >                config_name: test
                            >                 encryption: none
                            >                   home_dir: /{run_dir}
                            >                    log_dir: /{run_dir}/\.local/share/assimilate
                            >             match_archives: ↓
                            >                             - sh:{{host_name}}-{{user_name}}-{{config_name}}-\*
                            >            ❬when resolved❭: ↓
                            >                             - sh:.+-.+-test-\*
                            >                   patterns: ↓
                            >                             - R ~
                            >                             - - ~/\.cache
                            >                             - - ~/\.local
                            >                             - - ~/bu
                            >                             - - ~/REPO
                            >                 repository: ~/REPO/{{config_name}}
                            >            ❬when resolved❭: ~/REPO/test

            druggist — setting archive {{{2:
                run: assimilate setting archive
                checks:
                    stdout:
                        matches regex:
                            >                    archive: {{host_name}}-{{user_name}}-{{config_name}}-{{{{now}}}}
                            >            ❬when resolved❭: .*-test-{{now}}

            nettle — settings --available {{{2:
                run: assimilate settings --available
                checks:
                    stdout:
                        matches text:
                            > Assimilate settings:
                            >                    archive: template Borg should use when creating archive
                            >                             names
                            >         avendesora_account: account name that holds passphrase for
                            >                             encryption key in Avendesora
                            >            borg_executable: path to borg
                            >         check_after_create: run check as the last step of an archive
                            >                             creation
                            >                   cmd_name: name of Assimilate command being run (read
                            >                             only)
                            >                colorscheme: the color scheme
                            >            command_aliases: command aliases
                            >       compact_after_delete: run compact after deleting an archive or
                            >                             pruning a repository
                            >          composite_configs: composite configurations and their children
                            >                 config_dir: absolute path to configuration directory (read
                            >                             only)
                            >                config_name: name of active configuration (read only)
                            >             create_retries: number of times to retry a create if failures
                            >                             occur
                            >         create_retry_sleep: time to sleep between retries [s]
                            >                cronhub_url: the cronhub.io URL for back-ups monitor
                            >               cronhub_uuid: the cronhub.io UUID for back-ups monitor
                            >             default_config: default Assimilate configuration
                            >        default_list_format: the format that the list command should use if
                            >                             none is specified
                            >        default_mount_point: directory to use as mount point if one is not
                            >                             specified
                            >              do_not_expand: names of settings that must not undergo
                            >                             setting evaluation
                            >                   encoding: encoding when talking to borg
                            >                 encryption: encryption method (see Borg documentation)
                            >               exclude_from: file that contains exclude patterns
                            >                   excludes: list of glob strings of files or directories
                            >                             to skip
                            >           healthchecks_url: the healthchecks.io URL for monitoring back
                            >                             ups
                            >          healthchecks_uuid: the healthchecks.io UUID for monitoring back
                            >                             ups
                            >                   home_dir: users home directory (read only)
                            >                    include: include the contents of another file
                            >               list_formats: named format strings available to list command
                            >                    log_dir: log directory (read_only)
                            >                    logging: logging options
                            >           manage_diffs_cmd: command to use to manage differences in files
                            >                             and directories
                            >                 must_exist: if set, each of these files or directories
                            >                             must exist or create will quit with an error
                            >            needs_ssh_agent: when set Assimilate complains if ssh_agent is
                            >                             not available
                            >                   notifier: notification program
                            >                     notify: email address to notify when things go wrong
                            >                passcommand: command used by Borg to acquire the passphrase
                            >                 passphrase: passphrase for encryption key (if specified,
                            >                             Avendesora is not used)
                            >                   patterns: patterns that indicate whether a path should
                            >                             be included or excluded
                            >              patterns_from: file that contains patterns
                            >         prune_after_create: run prune after creating an archive
                            >           report_diffs_cmd: shell command to use to report differences in
                            >                             files and directories
                            >                 repository: path to remote directory that contains
                            >                             repository
                            >           run_after_backup: commands to run after archive has been created
                            >             run_after_borg: commands to run after last Borg command has
                            >                             run
                            >      run_after_last_backup: commands to run after last archive has been
                            >                             created
                            >          run_before_backup: commands to run before archive is created
                            >            run_before_borg: commands to run before first Borg command is
                            >                             run
                            >    run_before_first_backup: commands to run before first archive is
                            >                             created
                            >              show_progress: show borg progress when running create command
                            >                 show_stats: show borg statistics when running create,
                            >                             delete, and prune commands
                            >                   src_dirs: the directories to archive
                            >                ssh_command: command to use for SSH, can be used to specify
                            >                             SSH options
                            >                    verbose: make Borg more verbose
                            >                working_dir: working directory
                            >
                            > Borg settings:
                            >                append_only: create an append-only mode repository
                            >             chunker_params: specify the chunker parameters
                            >                compression: compression algorithm
                            >             exclude_caches: exclude directories that contain a
                            >                             CACHEDIR.TAG file
                            >         exclude_if_present: exclude directories that are tagged by
                            >                             containing a filesystem object with the given
                            >                             NAME
                            >             exclude_nodump: exclude files flagged NODUMP
                            >                 keep_daily: number of daily archives to keep
                            >                keep_hourly: number of hourly archives to keep
                            >                  keep_last: number of the most recent archives to keep
                            >              keep_minutely: number of minutely archives to keep
                            >               keep_monthly: number of monthly archives to keep
                            >                keep_weekly: number of weekly archives to keep
                            >                keep_within: keep all archives within this time interval
                            >                keep_yearly: number of yearly archives to keep
                            >                  lock_wait: wait at most SECONDS for acquiring a
                            >                             repository/cache lock (default: 1)
                            >             match_archives: only consider archive names that match the
                            >                             given glob pattern
                            >            one_file_system: stay in the same file system and do not store
                            >                             mount points of other file systems
                            >                remote_path: name of borg executable on remote platform
                            >                     sparse: detect sparse holes in input (supported only
                            >                             by fixed chunker)
                            >                  threshold: set minimum threshold in percent for saved
                            >                             space when compacting (default: 10)
                            >                      umask: set umask to M (local and remote, default:
                            >                             0077)
                            >              upload_buffer: set network upload buffer size in MiB
                            >                             (default: 0=no buffer)
                            >           upload_ratelimit: set rate limit in kiB/s, used when writing to
                            >                             a remote network (default: 0=unlimited)
                            >
                            > Read-only:
                            >                  host_name: the name of the computer running Assimlate
                            >                  user_name: the name of the user running Assimilate
                            >                  prog_name: the name of the command that runs Assimilate

            sixth — setting config_name {{{2:
                run: assimilate setting config_name
                checks:
                    stdout:
                        matches text:                config_name: test


    shaman — single config that uses patterns, explicit archive, and more complete settings {{{1:
        initialization:
            create:
                ~/.config/assimilate/shared.conf.nt:
                    contents:
                        > default config: test
                        > default mount point: ~/ASSIMILATE
                        > encryption: none
                        > report_diffs_cmd: diff -r --suppress-common-lines -x '.local'
                        >
                        > prune_after_create: 'yes
                        > check_after_create: 'latest
                        > compact_after_delete: 'yes
                        >
                        > exclude if present: .nobackup
                        > exclude caches: 'yes
                        > exclude nodump: 'yes
                        >
                        > keep within: 1d
                        > keep hourly: 0
                        > keep daily: 7
                        > keep weekly: 4
                        > keep monthly: 6
                        > keep yearly: 0
                        >
                        > command aliases:
                        >     repo-list: archives

                ~/REPO/:

                ~/.config/assimilate/test.conf.nt:
                    contents:
                        > repository: ~/REPO/{config_name}
                        > patterns:
                        >     - R ~
                        >     - - ~/.cache
                        >     - - ~/.local
                        >     - - ~/bu
                        >     - - ~/REPO

                ~/a:
                    contents: aaa
                    mtime: 2024-11-27

                ~/b:
                    contents: bbb
                    mtime: 2024-11-26

        tests:
            jogger — version {{{2:
                run: assimilate version
                checks:
                    stdout:
                        matches regex: assimilate version: \d+\.\d+(\.\d+)?(\.?\w+\d+)?  \(\d\d\d\d-\d\d-\d\d\) \[Python \d\.\d+\.\d+\]\.

            commander — help {{{2:
                run: assimilate help
                checks:
                    stdout:
                        matches text:
                            > Assimilate Backups
                            >
                            > Backs up the contents of a file hierarchy.  A front end for Borg's
                            > encrypted incremental backup utility.
                            >
                            > Usage:
                            >     assimilate [options] [<command> [<args>...]]
                            >
                            > Options:
                            >     -c <cfgname>, --config <cfgname>  Specifies the configuration to use.
                            >     -d, --dry-run                     Run Borg in dry run mode.
                            >     -h, --help                        Output basic usage information.
                            >     -m, --mute                        Suppress all output.
                            >     -n, --narrate                     Send Assimilate and Borg narration to stdout.
                            >     -q, --quiet                       Suppress optional output.
                            >     -r, --relocated                   Acknowledge that repository was relocated.
                            >     -v, --verbose                     Make Borg more verbose.
                            >     --no-log                          Do not create log file.
                            >
                            > Available commands:
                            >     borg              run a raw borg command
                            >     break-lock        breaks the repository and cache locks
                            >     check             checks the repository and its archives
                            >     compact           compact segment files in the repository
                            >     compare           compare local files or directories to those in an archive
                            >     configs           list available backup configurations
                            >     create            create an archive of the current files
                            >     delete            delete an archive currently contained in the repository
                            >     diff              show the differences between two archives
                            >     due               days since last backup
                            >     extract           recover file or files from archive
                            >     help              give information about commands or other topics
                            >     info              display metadata for a repository or archive
                            >     list              list the files contained in an archive
                            >     log               display log for the last assimilate run
                            >     mount             mount a repository or archive
                            >     overdue           show status of known repositories
                            >     prune             prune the repository of excess archives
                            >     repo-create       initialize the repository
                            >     repo-list         display available archives
                            >     repo-space        manage the amount of space kept in reserve
                            >     restore           restore requested files or directories in place
                            >     settings, setting
                            >                       display settings of chosen configuration
                            >     umount            un-mount a previously mounted repository or archive
                            >     undelete          remove deletion marker from selected archives
                            >     version           display assimilate version
                            >
                            > Available topics:
                            >     overview          overview of assimilate
                            >     precautions       what everybody should know before using assimilate

            grandma — help archives {{{2:
                run: assimilate help archives
                checks:
                    stdout:
                        matches text:
                            > ‘archives’ is an alias of ‘repo-list’.
                            >
                            > Display Available Archives.
                            >
                            > Usage:
                            >     assimilate repo-list [options]
                            >
                            > Options:
                            >     -f, --first <N>         consider first N archives that remain
                            >     -l, --last <N>          consider last N archives that remain
                            >     -n, --newer <age>       only consider archives newer than age
                            >     -o, --older <age>       only consider archives older than age
                            >     -N, --newest <range>    only consider archives between newest and
                            >                             newest-range
                            >     -O, --oldest <range>    only consider archives between oldest and
                            >                             oldest+range
                            >     -e, --include-external  list all archives in repository, not just
                            >                             those associated with this configuration
                            >     -d, --deleted           only archives archives marked for deletion

            albino — repo-create {{{2:
                run: assimilate repo-create
                checks:
                    stdout:
                        contains text: Reserve some repository storage space now for emergencies

                    ~/.local/share/assimilate/test.log:
                        contains text:
                            > running:
                            >     borg \
                            >         repo-create \
                            >         --repo=/{run_dir}/REPO/test \
                            >         --make-parent-dirs \
                            >         --encryption=none

                    ~/.local/share/assimilate/test.log.nt:
                        contains lines in order:
                            -     > running command: repo-create
                            -

            daddy — due {{{2:
                run: assimilate due
                checks:
                    stdout:
                        matches text:
                            > test backup never run.
                            > test compact never run.
                            > test check never run.

                    ~/.local/share/assimilate/test.log.nt:
                        excludes line:     > running command: due - fuxme

            clammy — create {{{2:
                run: assimilate create
                checks:
                    ~/.local/share/assimilate/test.log:
                        contains text:
                            > running:
                            >     borg \
                            >         create \
                            >         --repo=/{run_dir}/REPO/test \
                            >         '--pattern=R /{run_dir}' \
                            >         '--pattern=- /{run_dir}/.cache' \
                            >         '--pattern=- /{run_dir}/.local' \
                            >         '--pattern=- /{run_dir}/bu' \
                            >         '--pattern=- /{run_dir}/REPO' \
                            >         --stats \
                            >         --exclude-caches \
                            >         --exclude-nodump \
                            >         --exclude-if-present=.nobackup \
                            >         '{hostname}-{username}-test-{{now}}'

                    ~/.local/share/assimilate/test.log.nt:
                        contains lines in order:
                            -     > running command: create
                            -

                    ~/.local/share/assimilate/test.latest.nt:
                        contains regex: ^create last run: \d\d\d\d-\d\d-\d\dT\d\d:\d\d:\d\d.*$

            ceasefire — create again {{{2:
                initialization:
                    remove: ~/b
                run: assimilate
                checks:
                    ~/.local/share/assimilate/test.log:
                        contains text:
                            > running:
                            >     borg \
                            >         create \
                            >         --repo=/{run_dir}/REPO/test \
                            >         '--pattern=R /{run_dir}' \
                            >         '--pattern=- /{run_dir}/.cache' \
                            >         '--pattern=- /{run_dir}/.local' \
                            >         '--pattern=- /{run_dir}/bu' \
                            >         '--pattern=- /{run_dir}/REPO' \
                            >         --stats \
                            >         --exclude-caches \
                            >         --exclude-nodump \
                            >         --exclude-if-present=.nobackup \
                            >         '{hostname}-{username}-test-{{now}}'
                        contains text:
                            > running:
                            >     borg \
                            >         check \
                            >         --last=1 \
                            >         --repo=/{run_dir}/REPO/test \
                            >         '--match-archives=sh:{hostname}-{username}-test-*'
                        contains text:
                            > running:
                            >     borg \
                            >         prune \
                            >         --repo=/{run_dir}/REPO/test \
                            >         --keep-within=1d \
                            >         --keep-daily=7 \
                            >         --keep-weekly=4 \
                            >         --keep-monthly=6 \
                            >         '--match-archives=sh:{hostname}-{username}-test-*'
                        contains text:
                            > running:
                            >     borg \
                            >         compact \
                            >         --repo=/{run_dir}/REPO/test

                    ~/.local/share/assimilate/test.log.nt:
                        contains lines in order:
                            -     > running command: create
                            -

                    ~/.local/share/assimilate/test.latest.nt:
                        contains regex: ^create last run: \d\d\d\d-\d\d-\d\dT\d\d:\d\d:\d\d.*$

            unplug — repo-list {{{2:
                run: assimilate repo-list
                checks:
                    stdout:
                        matches regex:
                            > 1   aid:(?P<aid1>\w+)  (?P<ar1>[^ ]+)   .*
                            > 0   aid:(?P<aid0>\w+)  (?P<ar0>[^ ]+)   .*

                    ~/.local/share/assimilate/test.log:
                        contains text:
                            > running:
                            >     borg \
                            >         repo-list \
                            >         --json \
                            >         --repo=/{run_dir}/REPO/test \
                            >         '--match-archives=sh:{hostname}-{username}-test-*'

                    ~/.local/share/assimilate/test.log.nt:
                        contains lines in order:
                            -     > running command: repo-list
                            -

            editorial — repo-space {{{2:
                run: assimilate repo-space --reserve=1MiB
                checks:
                    stdout:
                        contains regex:
                            > There is [0-9.]+ MB reserved space in this repository now.

                    ~/.local/share/assimilate/test.log:
                        contains text:
                            > running:
                            >     borg \
                            >         repo-space \
                            >         --reserve=1048576 \
                            >         --repo=/{run_dir}/REPO/test

                    ~/.local/share/assimilate/test.log.nt:
                        contains lines in order:
                            -     > running command: repo-space
                            -


            fleet — repo-space {{{2:
                run: assimilate repo-space --free
                checks:
                    stdout:
                        contains regex:
                            > Freed [0-9.]+ MB in repository.

                    ~/.local/share/assimilate/test.log:
                        contains text:
                            > running:
                            >     borg \
                            >         repo-space \
                            >         --free \
                            >         --repo=/{run_dir}/REPO/test

                    ~/.local/share/assimilate/test.log.nt:
                        contains lines in order:
                            -     > running command: repo-space
                            -

            ligament — info {{{2:
                run: assimilate info
                checks:
                    stdout:
                        contains regex:
                            >               config: test
                            >                roots: /{run_dir}
                            >          destination: /{run_dir}/REPO/test
                            >   settings directory: /{run_dir}/.config/assimilate
                            >              logfile: /{run_dir}/.local/share/assimilate/test.log
                            >      create last run: .*
                            >       prune last run: .*
                            >     compact last run: .*
                            >       check last run: .*
                        contains regex:
                            > Repository ID: [a-f0-9]+
                            > Location: /{run_dir}/REPO/test
                            > Repository version: 3
                            > Append only: False
                            > Encrypted: No
                            > Storage quota: 0 B used
                            > Cache: /{run_dir}/.cache/borg/[a-f0-9]+
                            > Security dir: /{run_dir}/.local/share/borg/security/[a-f0-9]+

            atomizer — info --archive sh:❬ar0❭ {{{2:
                run: assimilate info --archive sh:{ar0}
                checks:
                    stdout:
                        contains regex:
                            > Archive name: {ar0}
                            > Archive fingerprint: [0-9a-f]+
                            > Comment: 
                            > Hostname: .+
                            > Username: .+
                            > Tags: 
                            > Time \(start\): .+
                            > Time \(end\): .+
                            > Duration: .+
                            > Command line: .+
                            > Number of files: 3
                            > Original size: \d+ B

            weekend — info --archive aid:❬aid0❭ {{{2:
                run: assimilate info --archive aid:{aid0}
                checks:
                    stdout:
                        contains regex:
                            > Archive name: {ar0}
                            > Archive fingerprint: [0-9a-f]+
                            > Comment: 
                            > Hostname: .+
                            > Username: .+
                            > Tags: 
                            > Time \(start\): .+
                            > Time \(end\): .+
                            > Duration: .+
                            > Command line: .+
                            > Number of files: 3
                            > Original size: \d+ B

            nuthouse — info --fast {{{2:
                run: assimilate info --fast
                checks:
                    stdout:
                        contains regex:
                            >               config: test
                            >                roots: /{run_dir}
                            >          destination: /{run_dir}/REPO/test
                            >   settings directory: /{run_dir}/.config/assimilate
                            >              logfile: /{run_dir}/.local/share/assimilate/test.log
                            >      create last run: .*
                            >       prune last run: .*
                            >     compact last run: .*
                            >       check last run: .*

            embolden — list {{{2:
                run: assimilate list
                checks:
                    stdout:
                        contains lines:
                            - {run_dir}/
                            - {run_dir}/.config/
                            - {run_dir}/.config/assimilate/
                            - {run_dir}/.config/assimilate/shared.conf.nt
                            - {run_dir}/.config/assimilate/test.conf.nt
                            - {run_dir}/a

                    stderr:
                        matches regex:
                            > archive: {aid0} {ar0} .*

                    ~/.local/share/assimilate/test.log:
                        contains text:
                            > running:
                            >     borg \
                            >         repo-list \
                            >         --repo=/{run_dir}/REPO/test \
                            >         '--match-archives=sh:{hostname}-{username}-test-*' \
                            >         --json \
                            >         --last=1
                        contains text:
                            > running:
                            >     borg \
                            >         list \
                            >         --repo=/{run_dir}/REPO/test \
                            >         --json-lines \
                            >         '--format={{path}}{{type}}' \
                            >         aid:{aid0}

                    ~/.local/share/assimilate/test.log.nt:
                        contains lines in order:
                            -     > running command: list
                            -

            souvenir — list {{{2:
                run: assimilate list -a aid:{aid1}
                checks:
                    stdout:
                        contains lines:
                            - {run_dir}/
                            - {run_dir}/.config/
                            - {run_dir}/.config/assimilate/
                            - {run_dir}/.config/assimilate/shared.conf.nt
                            - {run_dir}/.config/assimilate/test.conf.nt
                            - {run_dir}/a
                            - {run_dir}/b

                    ~/.local/share/assimilate/test.log:
                        contains text:
                            > running:
                            >     borg \
                            >         list \
                            >         --repo=/{run_dir}/REPO/test \
                            >         --json-lines \
                            >         '--format={{path}}{{type}}' \
                            >         aid:{aid1}

                    ~/.local/share/assimilate/test.log.nt:
                        contains lines in order:
                            -     > running command: list
                            -

            fraud — break-lock {{{2:
                # there is no lock to break, but exercise the command anyway
                run: assimilate break-lock
                checks:
                    ~/.local/share/assimilate/test.log:
                        contains text:
                            > running:
                            >     borg \
                            >         break-lock \
                            >         --repo=/{run_dir}/REPO/test

                    ~/.local/share/assimilate/test.log.nt:
                        contains lines in order:
                            -     > running command: break-lock
                            -

            grapple — prune {{{2:
                run: assimilate prune
                checks:
                    ~/.local/share/assimilate/test.log:
                        contains text:
                            > running:
                            >     borg \
                            >         prune \
                            >         --repo=/{run_dir}/REPO/test \
                            >         --keep-within=1d \
                            >         --keep-daily=7 \
                            >         --keep-weekly=4 \
                            >         --keep-monthly=6 \
                            >         '--match-archives=sh:{hostname}-{username}-test-*'
                        contains text:
                            > running:
                            >     borg \
                            >         compact \
                            >         --repo=/{run_dir}/REPO/test

                    ~/.local/share/assimilate/test.log.nt:
                        contains text:
                            >     > running:
                            >     >     borg \
                            >     >         prune \
                            >     >         --repo=/{run_dir}/REPO/test \
                            >     >         --keep-within=1d \
                            >     >         --keep-daily=7 \
                            >     >         --keep-weekly=4 \
                            >     >         --keep-monthly=6 \
                            >     >         '--match-archives=sh:{hostname}-{username}-test-*'
                        contains text:
                            >     > running:
                            >     >     borg \
                            >     >         compact \
                            >     >         --repo=/{run_dir}/REPO/test

                    ~/.local/share/assimilate/test.latest.nt:
                        contains regex: ^prune last run: \d\d\d\d-\d\d-\d\dT\d\d:\d\d:\d\d.*$

            small — compact {{{2:
                run: assimilate compact
                checks:
                    ~/.local/share/assimilate/test.log:
                        contains text:
                            > running:
                            >     borg \
                            >         compact \
                            >         --repo=/{run_dir}/REPO/test

                    ~/.local/share/assimilate/test.log.nt:
                        contains lines in order:
                            -     > running command: compact
                            -

                    ~/.local/share/assimilate/test.latest.nt:
                        contains regex: ^compact last run: \d\d\d\d-\d\d-\d\dT\d\d:\d\d:\d\d.*$


            exult — check {{{2:
                run: assimilate check
                checks:
                    ~/.local/share/assimilate/test.log:
                        contains text:
                            > running:
                            >     borg \
                            >         check \
                            >         --last=1 \
                            >         --repo=/{run_dir}/REPO/test \
                            >         '--match-archives=sh:{hostname}-{username}-test-*'

                    ~/.local/share/assimilate/test.log.nt:
                        contains text:
                            >     > running:
                            >     >     borg \
                            >     >         check \
                            >     >         --last=1 \
                            >     >         --repo=/{run_dir}/REPO/test \
                            >     >         '--match-archives=sh:{hostname}-{username}-test-*'

                    ~/.local/share/assimilate/test.latest.nt:
                        contains regex: ^check last run: \d\d\d\d-\d\d-\d\dT\d\d:\d\d:\d\d.*$


            publisher — compare {{{2:
                run: assimilate compare
                checks:
                    stdout:
                        contains lines:
                            - Only in .: ASSIMILATE
                            - Only in .: bu
                            - Only in .: .cache
                            - Only in .: REPO

                    stderr:
                        matches regex:
                            > archive: {aid0} {ar0} .*

                    status: 1

            coffee — compare -a {{{2:
                run: assimilate compare -a aid:{aid1}
                checks:
                    stdout:
                        contains lines:
                            - Only in .: ASSIMILATE
                            - Only in /{run_dir}/ASSIMILATE/{ar1}/{run_dir}: b
                            - Only in .: bu
                            - Only in .: .cache
                            - Only in .: REPO
                    status: 1

            urinate — diff {{{2:
                run: assimilate diff aid:{aid1} aid:{aid0}
                checks:
                    stdout:
                        matches text:
                            > ctime               {run_dir}
                            > removed             {run_dir}/b
                    status: 1

            wobble — configs {{{2:
                run: assimilate configs
                checks:
                    stdout:
                        matches text:
                            > Available Configurations:
                            >     test
                            >
                            > Default Configuration:
                            >     test

            persevere — mount {{{2:
                run: assimilate mount
                checks:
                    stderr:
                        matches regex: mount point is: /{run_dir}/ASSIMILATE

                    ~/.local/share/assimilate/test.log:
                        contains text:
                            > running:
                            >     borg \
                            >         mount \
                            >         --repo=/{run_dir}/REPO/test \
                            >         '--match-archives=sh:{hostname}-{username}-test-*' \
                            >         /{run_dir}/ASSIMILATE

                    ~/.local/share/assimilate/test.log.nt:
                        contains text:
                            >     > running:
                            >     >     borg \
                            >     >         mount \
                            >     >         --repo=/{run_dir}/REPO/test \
                            >     >         '--match-archives=sh:{hostname}-{username}-test-*' \
                            >     >         /{run_dir}/ASSIMILATE

                    ~/ASSIMILATE/{ar1}/{run_dir}/a:
                        matches text: aaa

                    ~/ASSIMILATE/{ar1}/{run_dir}/b:
                        matches text: bbb

                    ~/ASSIMILATE/{ar0}/{run_dir}/a:
                        matches text: aaa

            woodshed — umount {{{2:
                run: assimilate umount

            gobbler — restore {{{2:
                run: assimilate restore -a aid:{aid1} b
                checks:
                    ~/b:
                        matches text: bbb

            invasion — restore <path>... {{{2:
                initialization:
                    remove:
                        - ~/a
                        - ~/b
                run: assimilate restore -a aid:{aid1} a b
                checks:
                    ~/a:
                        matches text: aaa
                    ~/b:
                        matches text: bbb

            farmhouse — extract {{{2:
                run: assimilate extract -a aid:{aid1} {run_dir}/a
                checks:
                    ~/{run_dir}/a:
                        matches text: aaa

            comfy — extract {{{2:
                run: assimilate extract -a aid:{aid1} /{run_dir}/b
                checks:
                    ~/{run_dir}/b:
                        matches text: bbb

            genital — delete {{{2:
                initialization:
                    remove: ~/.local/share/assimilate/test.latest.nt
                run: assimilate delete -a aid:{aid1}
                checks:
                    ~/.local/share/assimilate/test.log:
                        contains text:
                            > running:
                            >     borg \
                            >         delete \
                            >         --match-archives=aid:{aid1} \
                            >         --repo=/{run_dir}/REPO/test

                        contains text:
                            > running:
                            >     borg \
                            >         compact \
                            >         --repo=/{run_dir}/REPO/test

                    ~/.local/share/assimilate/test.log.nt:
                        contains lines in order:
                            -     > running command: delete
                            -     > running command: compact
                            -

                    ~/.local/share/assimilate/test.latest.nt:
                        matches regex: ^compact last run: \d\d\d\d-\d\d-\d\dT\d\d:\d\d:\d\d.*$


            dawdle — repo-list {{{2:
                run: assimilate repo-list
                checks:
                    stdout:
                        matches regex:
                            > 0   aid:(?P<aid0>\w+)  (?P<ar0>[^ ]+)   .*

                    ~/.local/share/assimilate/test.log:
                        contains text:
                            > running:
                            >     borg \
                            >         repo-list \
                            >         --json \
                            >         --repo=/{run_dir}/REPO/test \
                            >         '--match-archives=sh:{hostname}-{username}-test-*'

                    ~/.local/share/assimilate/test.log.nt:
                        contains lines in order:
                            -     > running command: repo-list
                            -

            mossy — log {{{2:
                run: assimilate log
                checks:
                    stdout:
                        contains regex:
                            > aid:{aid0}  {ar0}   .*

            pension — borg repo-list {{{2:
                run: assimilate borg -r @repo repo-list
                checks:
                    stdout:
                        matches regex:
                            > {aid0}  .*  {ar0}  .*


    beautify — single config that uses patterns, explicit archive, and more complete settings {{{1:
        initialization:
            create:
                ~/.config/assimilate/shared.conf.nt:
                    contents:
                        > default config: test
                        > default mount point: ~/ASSIMILATE
                        > encryption: repokey-blake2-chacha20-poly1305
                        > compression: zstd,1
                        > passphrase: roadhouse pause govern parry
                        > report_diffs_cmd: diff -r --suppress-common-lines -x '.local'
                        >
                        > prune_after_create: 'yes
                        > check_after_create: 'latest
                        > compact_after_delete: 'yes
                        >
                        > exclude if present: .nobackup
                        > exclude caches: 'yes
                        > exclude nodump: 'yes
                        >
                        > keep within: 1d
                        > keep hourly: 0
                        > keep daily: 7
                        > keep weekly: 4
                        > keep monthly: 6
                        > keep yearly: 0
                        >
                        > command aliases:
                        >     repo-list:
                        >         - recent --last=20

                ~/.config/assimilate/test.conf.nt:
                    contents:
                        > repository: ~/REPO/{config_name}
                        > archive: {config_name}
                        > match archives: id:{config_name}
                        > patterns:
                        >     - R ~
                        >     - - ~/.cache
                        >     - - ~/.local
                        >     - - ~/bu
                        >     - - ~/REPO

                ~/REPO/:

                ~/a:
                    contents: aaa
                    mtime: 2024-11-27

                ~/b:
                    contents: bbb
                    mtime: 2024-11-26

        tests:
            compel — version {{{2:
                run: assimilate version
                checks:
                    stdout:
                        matches regex: assimilate version: \d+\.\d+(\.\d+)?(\.?\w+\d+)?  \(\d\d\d\d-\d\d-\d\d\) \[Python \d\.\d+\.\d+\]\.

            yearning — help {{{2:
                run: assimilate help
                checks:
                    stdout:
                        matches text:
                            > Assimilate Backups
                            >
                            > Backs up the contents of a file hierarchy.  A front end for Borg's
                            > encrypted incremental backup utility.
                            >
                            > Usage:
                            >     assimilate [options] [<command> [<args>...]]
                            >
                            > Options:
                            >     -c <cfgname>, --config <cfgname>  Specifies the configuration to use.
                            >     -d, --dry-run                     Run Borg in dry run mode.
                            >     -h, --help                        Output basic usage information.
                            >     -m, --mute                        Suppress all output.
                            >     -n, --narrate                     Send Assimilate and Borg narration to stdout.
                            >     -q, --quiet                       Suppress optional output.
                            >     -r, --relocated                   Acknowledge that repository was relocated.
                            >     -v, --verbose                     Make Borg more verbose.
                            >     --no-log                          Do not create log file.
                            >
                            > Available commands:
                            >     borg              run a raw borg command
                            >     break-lock        breaks the repository and cache locks
                            >     check             checks the repository and its archives
                            >     compact           compact segment files in the repository
                            >     compare           compare local files or directories to those in an archive
                            >     configs           list available backup configurations
                            >     create            create an archive of the current files
                            >     delete            delete an archive currently contained in the repository
                            >     diff              show the differences between two archives
                            >     due               days since last backup
                            >     extract           recover file or files from archive
                            >     help              give information about commands or other topics
                            >     info              display metadata for a repository or archive
                            >     list              list the files contained in an archive
                            >     log               display log for the last assimilate run
                            >     mount             mount a repository or archive
                            >     overdue           show status of known repositories
                            >     prune             prune the repository of excess archives
                            >     repo-create       initialize the repository
                            >     repo-list         display available archives
                            >     repo-space        manage the amount of space kept in reserve
                            >     restore           restore requested files or directories in place
                            >     settings, setting
                            >                       display settings of chosen configuration
                            >     umount            un-mount a previously mounted repository or archive
                            >     undelete          remove deletion marker from selected archives
                            >     version           display assimilate version
                            >
                            > Available topics:
                            >     overview          overview of assimilate
                            >     precautions       what everybody should know before using assimilate

            diary — help recent {{{2:
                run: assimilate help recent
                checks:
                    stdout:
                        matches text:
                            > ‘recent’ is an alias of ‘repo-list --last=20’.
                            >
                            > Display Available Archives.
                            >
                            > Usage:
                            >     assimilate repo-list [options]
                            >
                            > Options:
                            >     -f, --first <N>         consider first N archives that remain
                            >     -l, --last <N>          consider last N archives that remain
                            >     -n, --newer <age>       only consider archives newer than age
                            >     -o, --older <age>       only consider archives older than age
                            >     -N, --newest <range>    only consider archives between newest and
                            >                             newest-range
                            >     -O, --oldest <range>    only consider archives between oldest and
                            >                             oldest+range
                            >     -e, --include-external  list all archives in repository, not just
                            >                             those associated with this configuration
                            >     -d, --deleted           only archives archives marked for deletion


            epicenter — repo-create {{{2:
                run: assimilate repo-create
                checks:
                    stdout:
                        contains text: Reserve some repository storage space now for emergencies

                    ~/.local/share/assimilate/test.log:
                        contains text:
                            > Borg-related environment variables: {{
                            >     'BORG_PASSPHRASE': '❬redacted❭',
                            >     'BORG_DISPLAY_PASSPHRASE': 'no',
                            > }}
                        excludes text: roadhouse pause govern parry
                        contains text:
                            > running:
                            >     borg \
                            >         repo-create \
                            >         --repo=/{run_dir}/REPO/test \
                            >         --make-parent-dirs \
                            >         --encryption=repokey-blake2-chacha20-poly1305

                    ~/.local/share/assimilate/test.log.nt:
                        contains lines in order:
                            -     > running command: repo-create
                            -

            promoter — due {{{2:
                run: assimilate due
                checks:
                    stdout:
                        matches text:
                            > test backup never run.
                            > test compact never run.
                            > test check never run.

                    ~/.local/share/assimilate/test.log.nt:
                        excludes line:     > running command: due

            facsimile — create {{{2:
                run: assimilate create
                checks:
                    ~/.local/share/assimilate/test.log:
                        contains text:
                            > Borg-related environment variables: {{
                            >     'BORG_PASSPHRASE': '❬redacted❭',
                            >     'BORG_DISPLAY_PASSPHRASE': 'no',
                            > }}
                        excludes text: roadhouse pause govern parry
                        contains text:
                            > running:
                            >     borg \
                            >         create \
                            >         --repo=/{run_dir}/REPO/test \
                            >         '--pattern=R /{run_dir}' \
                            >         '--pattern=- /{run_dir}/.cache' \
                            >         '--pattern=- /{run_dir}/.local' \
                            >         '--pattern=- /{run_dir}/bu' \
                            >         '--pattern=- /{run_dir}/REPO' \
                            >         --stats \
                            >         --compression=zstd,1 \
                            >         --exclude-caches \
                            >         --exclude-nodump \
                            >         --exclude-if-present=.nobackup \
                            >         test
                        contains text:
                            > running:
                            >     borg \
                            >         check \
                            >         --last=1 \
                            >         --repo=/{run_dir}/REPO/test \
                            >         --match-archives=sh:test
                        contains text:
                            > running:
                            >     borg \
                            >         prune \
                            >         --repo=/{run_dir}/REPO/test \
                            >         --keep-within=1d \
                            >         --keep-daily=7 \
                            >         --keep-weekly=4 \
                            >         --keep-monthly=6 \
                            >         --match-archives=sh:test
                        contains text:
                            > running:
                            >     borg \
                            >         compact \
                            >         --repo=/{run_dir}/REPO/test

                    ~/.local/share/assimilate/test.log.nt:
                        contains lines in order:
                            -     > running command: create
                            -

                    ~/.local/share/assimilate/test.latest.nt:
                        contains regex: ^create last run: \d\d\d\d-\d\d-\d\dT\d\d:\d\d:\d\d.*$

            consulate — create again {{{2:
                initialization:
                    remove: ~/b
                    create:
                        ~/c:
                            contents: ccc
                            mtime: 2024-11-28
                run: assimilate
                checks:
                    ~/.local/share/assimilate/test.log:
                        contains text:
                            > Borg-related environment variables: {{
                            >     'BORG_PASSPHRASE': '❬redacted❭',
                            >     'BORG_DISPLAY_PASSPHRASE': 'no',
                            > }}
                        excludes text: roadhouse pause govern parry
                        contains text:
                            > running:
                            >     borg \
                            >         create \
                            >         --repo=/{run_dir}/REPO/test \
                            >         '--pattern=R /{run_dir}' \
                            >         '--pattern=- /{run_dir}/.cache' \
                            >         '--pattern=- /{run_dir}/.local' \
                            >         '--pattern=- /{run_dir}/bu' \
                            >         '--pattern=- /{run_dir}/REPO' \
                            >         --stats \
                            >         --compression=zstd,1 \
                            >         --exclude-caches \
                            >         --exclude-nodump \
                            >         --exclude-if-present=.nobackup \
                            >         test
                        contains text:
                            > running:
                            >     borg \
                            >         check \
                            >         --last=1 \
                            >         --repo=/{run_dir}/REPO/test \
                            >         --match-archives=sh:test
                        contains text:
                            > running:
                            >     borg \
                            >         prune \
                            >         --repo=/{run_dir}/REPO/test \
                            >         --keep-within=1d \
                            >         --keep-daily=7 \
                            >         --keep-weekly=4 \
                            >         --keep-monthly=6 \
                            >         --match-archives=sh:test
                        contains text:
                            > running:
                            >     borg \
                            >         compact \
                            >         --repo=/{run_dir}/REPO/test

                    ~/.local/share/assimilate/test.log.nt:
                        contains lines in order:
                            -     > running command: create
                            -

                    ~/.local/share/assimilate/test.latest.nt:
                        contains regex: ^create last run: \d\d\d\d-\d\d-\d\dT\d\d:\d\d:\d\d.*$

            touchdown — repo-list {{{2:
                run: assimilate repo-list
                checks:
                    stdout:
                        matches regex:
                            > 1   aid:(?P<aid1>\w+)  (?P<ar1>[^ ]+)   .*
                            > 0   aid:(?P<aid0>\w+)  (?P<ar0>[^ ]+)   .*

                    ~/.local/share/assimilate/test.log:
                        contains text:
                            > Borg-related environment variables: {{
                            >     'BORG_PASSPHRASE': '❬redacted❭',
                            >     'BORG_DISPLAY_PASSPHRASE': 'no',
                            > }}
                        excludes text: roadhouse pause govern parry
                        contains text:
                            > running:
                            >     borg \
                            >         repo-list \
                            >         --json \
                            >         --repo=/{run_dir}/REPO/test \
                            >         --match-archives=sh:test

                    ~/.local/share/assimilate/test.log.nt:
                        contains lines in order:
                            -     > running command: repo-list
                            -

            romance — info {{{2:
                run: assimilate info
                checks:
                    stdout:
                        contains regex:
                            >               config: test
                            >                roots: /{run_dir}
                            >          destination: /{run_dir}/REPO/test
                            >   settings directory: /{run_dir}/.config/assimilate
                            >              logfile: /{run_dir}/.local/share/assimilate/test.log
                            >      create last run: .*
                            >       prune last run: .*
                            >     compact last run: .*
                            >       check last run: .*
                        contains regex:
                            > Repository ID: [a-f0-9]+
                            > Location: /{run_dir}/REPO/test
                            > Repository version: 3
                            > Append only: False
                            > Encrypted: Yes \(repokey BLAKE2b ChaCha20-Poly1305\)
                            > Storage quota: 0 B used
                            > Cache: /{run_dir}/.cache/borg/[a-f0-9]+
                            > Security dir: /{run_dir}/.local/share/borg/security/[a-f0-9]+

                    ~/.local/share/assimilate/test.log:
                        contains text:
                            > Borg-related environment variables: {{
                            >     'BORG_PASSPHRASE': '❬redacted❭',
                            >     'BORG_DISPLAY_PASSPHRASE': 'no',
                            > }}
                        excludes text: roadhouse pause govern parry
                        contains text:
                            > running:
                            >     borg \
                            >         repo-info \
                            >         --repo=/{run_dir}/REPO/test

                    ~/.local/share/assimilate/test.log.nt:
                        contains lines in order:
                            -     > running command: info
                            -

            contract — list {{{2:
                run: assimilate list
                checks:
                    stdout:
                        contains lines:
                            - {run_dir}/
                            - {run_dir}/.config/
                            - {run_dir}/.config/assimilate/
                            - {run_dir}/.config/assimilate/shared.conf.nt
                            - {run_dir}/.config/assimilate/test.conf.nt
                            - {run_dir}/a
                            - {run_dir}/c

                    stderr:
                        matches regex:
                            > archive: {aid0} {ar0} .*

                    ~/.local/share/assimilate/test.log:
                        contains text:
                            > Borg-related environment variables: {{
                            >     'BORG_PASSPHRASE': '❬redacted❭',
                            >     'BORG_DISPLAY_PASSPHRASE': 'no',
                            > }}
                        excludes text: roadhouse pause govern parry
                        contains text:
                            > running:
                            >     borg \
                            >         repo-list \
                            >         --repo=/{run_dir}/REPO/test \
                            >         --match-archives=sh:test \
                            >         --json \
                            >         --last=1
                        contains text:
                            > running:
                            >     borg \
                            >         list \
                            >         --repo=/{run_dir}/REPO/test \
                            >         --json-lines \
                            >         '--format={{path}}{{type}}' \
                            >         aid:{aid0}

                    ~/.local/share/assimilate/test.log.nt:
                        contains lines in order:
                            -     > running command: list
                            -

            ninny — list {{{2:
                run: assimilate list -a aid:{aid1}
                checks:
                    stdout:
                        contains lines:
                            - {run_dir}/
                            - {run_dir}/.config/
                            - {run_dir}/.config/assimilate/
                            - {run_dir}/.config/assimilate/shared.conf.nt
                            - {run_dir}/.config/assimilate/test.conf.nt
                            - {run_dir}/a
                            - {run_dir}/b

                    ~/.local/share/assimilate/test.log:
                        contains text:
                            > running:
                            >     borg \
                            >         list \
                            >         --repo=/{run_dir}/REPO/test \
                            >         --json-lines \
                            >         '--format={{path}}{{type}}' \
                            >         aid:{aid1}

                    ~/.local/share/assimilate/test.log.nt:
                        contains lines in order:
                            -     > running command: list
                            -

            bully — break-lock {{{2:
                # there is no lock to break, but exercise the command anyway
                run: assimilate break-lock
                checks:
                    ~/.local/share/assimilate/test.log:
                        contains text:
                            > Borg-related environment variables: {{
                            >     'BORG_PASSPHRASE': '❬redacted❭',
                            >     'BORG_DISPLAY_PASSPHRASE': 'no',
                            > }}
                        excludes text: roadhouse pause govern parry
                        contains text:
                            > running:
                            >     borg \
                            >         break-lock \
                            >         --repo=/{run_dir}/REPO/test

                    ~/.local/share/assimilate/test.log.nt:
                        contains lines in order:
                            -     > running command: break-lock
                            -

            fluster — prune {{{2:
                run: assimilate prune
                checks:
                    ~/.local/share/assimilate/test.log:
                        contains text:
                            > Borg-related environment variables: {{
                            >     'BORG_PASSPHRASE': '❬redacted❭',
                            >     'BORG_DISPLAY_PASSPHRASE': 'no',
                            > }}
                        excludes text: roadhouse pause govern parry
                        contains text:
                            > running:
                            >     borg \
                            >         prune \
                            >         --repo=/{run_dir}/REPO/test \
                            >         --keep-within=1d \
                            >         --keep-daily=7 \
                            >         --keep-weekly=4 \
                            >         --keep-monthly=6 \
                            >         --match-archives=sh:test
                        contains text:
                            > running:
                            >     borg \
                            >         compact \
                            >         --repo=/tmp/pytest-of-ken/pytest-0/test_assimilate_4_0/REPO/test

                    ~/.local/share/assimilate/test.log.nt:
                        contains lines in order:
                            -     > running command: prune
                            -

                    ~/.local/share/assimilate/test.latest.nt:
                        contains regex: ^prune last run: \d\d\d\d-\d\d-\d\dT\d\d:\d\d:\d\d.*$

            optician — compact {{{2:
                run: assimilate compact
                checks:
                    ~/.local/share/assimilate/test.log:
                        contains text:
                            > Borg-related environment variables: {{
                            >     'BORG_PASSPHRASE': '❬redacted❭',
                            >     'BORG_DISPLAY_PASSPHRASE': 'no',
                            > }}
                        excludes text: roadhouse pause govern parry
                        contains text:
                            > running:
                            >     borg \
                            >         compact \
                            >         --repo=/{run_dir}/REPO/test

                    ~/.local/share/assimilate/test.log.nt:
                        contains lines in order:
                            -     > running command: compact
                            -

                    ~/.local/share/assimilate/test.latest.nt:
                        contains regex: ^compact last run: \d\d\d\d-\d\d-\d\dT\d\d:\d\d:\d\d.*$


            waggle — check {{{2:
                run: assimilate check --repair
                checks:
                    # stdout:
                    #      matches text:
                    #          > This is a potentially dangerous function.
                    #          > check --repair might lead to data loss (for kinds of corruption it is not
                    #          > capable of dealing with). BE VERY CAREFUL!
                    #          >
                    #          > Type 'YES' if you understand this and want to continue: YES (from BORG_CHECK_I_KNOW_WHAT_I_AM_DOING)
                    #      sometimes borg prints this message, and some times it does not.

                    ~/.local/share/assimilate/test.log:
                        contains text:
                            > Borg-related environment variables: {{
                            >     'BORG_CHECK_I_KNOW_WHAT_I_AM_DOING': 'YES',
                            >     'BORG_PASSPHRASE': '❬redacted❭',
                            >     'BORG_DISPLAY_PASSPHRASE': 'no',
                            > }}
                        excludes text: roadhouse pause govern parry
                        contains text:
                            > running:
                            >     borg \
                            >         check \
                            >         --last=1 \
                            >         --repo=/{run_dir}/REPO/test \
                            >         --match-archives=sh:test

                    ~/.local/share/assimilate/test.log.nt:
                        contains text:
                            >     > running:
                            >     >     borg \
                            >     >         check \
                            >     >         --last=1 \
                            >     >         --repo=/{run_dir}/REPO/test \
                            >     >         --match-archives=sh:test

                    ~/.local/share/assimilate/test.latest.nt:
                        contains regex: ^check last run: \d\d\d\d-\d\d-\d\dT\d\d:\d\d:\d\d.*$


            arrowhead — compare {{{2:
                run: assimilate compare
                checks:
                    stdout:
                        contains lines:
                            - Only in .: ASSIMILATE
                            - Only in .: bu
                            - Only in .: .cache
                            - Only in .: REPO

                    stderr:
                        matches regex:
                            > archive: {aid0} {ar0} .*

                    status: 1

            adapt — compare -a {{{2:
                run: assimilate compare -a aid:{aid1}
                checks:
                    stdout:
                        contains lines:
                            - Only in .: ASSIMILATE
                            - Only in /{run_dir}/ASSIMILATE/{ar1}/{run_dir}: b
                            - Only in .: bu
                            - Only in .: c
                            - Only in .: .cache
                            - Only in .: REPO
                    status: 1

            detach — diff {{{2:
                run: assimilate diff aid:{aid1} aid:{aid0}
                checks:
                    stdout:
                        matches text:
                            > ctime               {run_dir}
                            > added               {run_dir}/c
                            > removed             {run_dir}/b
                    status: 1

            publicist — configs {{{2:
                run: assimilate configs
                checks:
                    stdout:
                        matches text:
                            > Available Configurations:
                            >     test
                            >
                            > Default Configuration:
                            >     test

            voter — mount {{{2:
                run: assimilate mount
                checks:
                    stderr:
                        matches regex: mount point is: /{run_dir}/ASSIMILATE

                    ~/.local/share/assimilate/test.log:
                        contains text:
                            > Borg-related environment variables: {{
                            >     'BORG_PASSPHRASE': '❬redacted❭',
                            >     'BORG_DISPLAY_PASSPHRASE': 'no',
                            > }}
                        excludes text: roadhouse pause govern parry
                        contains text:
                            > running:
                            >     borg \
                            >         mount \
                            >         --repo=/{run_dir}/REPO/test \
                            >         --match-archives=sh:test \
                            >         /{run_dir}/ASSIMILATE

                    ~/.local/share/assimilate/test.log.nt:
                        contains text:
                            >     > running:
                            >     >     borg \
                            >     >         mount \
                            >     >         --repo=/{run_dir}/REPO/test \
                            >     >         --match-archives=sh:test \
                            >     >         /{run_dir}/ASSIMILATE

                    ~/ASSIMILATE/{ar1}-{aid1}/{run_dir}/a:
                        matches text: aaa

                    ~/ASSIMILATE/{ar1}-{aid1}/{run_dir}/b:
                        matches text: bbb

                    ~/ASSIMILATE/{ar0}-{aid0}/{run_dir}/a:
                        matches text: aaa

            inspect — umount {{{2:
                run: assimilate umount
                checks:
                    ~/.local/share/assimilate/test.log:
                        contains text:
                            > Borg-related environment variables: {{
                            >     'BORG_PASSPHRASE': '❬redacted❭',
                            >     'BORG_DISPLAY_PASSPHRASE': 'no',
                            > }}
                        excludes text: roadhouse pause govern parry
                        contains text:
                            > running:
                            >     borg \
                            >         umount \
                            >         --repo=/{run_dir}/REPO/test \
                            >         /{run_dir}/ASSIMILATE

                    ~/.local/share/assimilate/test.log.nt:
                        contains lines in order:
                            -     > running command: umount
                            -

            debutante — restore {{{2:
                run: assimilate restore -a aid:{aid1} b
                checks:
                    ~/b:
                        matches text: bbb

            sovereign — extract {{{2:
                run: assimilate extract -a aid:{aid1} {run_dir}/a
                checks:
                    ~/{run_dir}/a:
                        matches text: aaa

            vassal — extract {{{2:
                run: assimilate extract -a aid:{aid1} /{run_dir}/b
                checks:
                    ~/{run_dir}/b:
                        matches text: bbb

            promote — delete {{{2:
                initialization:
                    remove: ~/.local/share/assimilate/test.latest.nt
                run: assimilate delete -a aid:{aid1}
                checks:
                    ~/.local/share/assimilate/test.log:
                        contains text:
                            > Borg-related environment variables: {{
                            >     'BORG_PASSPHRASE': '❬redacted❭',
                            >     'BORG_DISPLAY_PASSPHRASE': 'no',
                            > }}
                        excludes text: roadhouse pause govern parry
                        contains text:
                            > running:
                            >     borg \
                            >         delete \
                            >         --match-archives=aid:{aid1} \
                            >         --repo=/{run_dir}/REPO/test
                        contains text:
                            > running:
                            >     borg \
                            >         compact \
                            >         --repo=/{run_dir}/REPO/test


                    ~/.local/share/assimilate/test.log.nt:
                        contains lines in order:
                            -     > running command: delete
                            -

                    ~/.local/share/assimilate/test.latest.nt:
                        matches regex: ^compact last run: \d\d\d\d-\d\d-\d\dT\d\d:\d\d:\d\d.*$


            hospice — repo-list {{{2:
                run: assimilate repo-list
                checks:
                    stdout:
                        matches regex:
                            > 0   aid:(?P<aid0>\w+)  (?P<ar0>[^ ]+)   .*

                    ~/.local/share/assimilate/test.log:
                        contains text:
                            > Borg-related environment variables: {{
                            >     'BORG_PASSPHRASE': '❬redacted❭',
                            >     'BORG_DISPLAY_PASSPHRASE': 'no',
                            > }}
                        excludes text: roadhouse pause govern parry
                        contains text:
                            > running:
                            >     borg \
                            >         repo-list \
                            >         --json \
                            >         --repo=/{run_dir}/REPO/test \
                            >         --match-archives=sh:test

                    ~/.local/share/assimilate/test.log.nt:
                        contains lines in order:
                            -     > running command: repo-list
                            -

            imprint — log {{{2:
                run: assimilate log
                checks:
                    stdout:
                        contains regex:
                            > aid:{aid0}  {ar0}   .*

            dinosaur — borg repo-list {{{2:
                run: assimilate borg --repo @repo repo-list
                checks:
                    stdout:
                        matches regex:
                            > {aid0}  .*  {ar0}  .*

    daemon — composite config that uses patterns and implicit archive {{{1:
        initialization:
            create:
                ~/.config/assimilate/shared.conf.nt:
                    contents:
                        > default config: test
                        > composite configs:
                        >     test: test1 test2
                        > default mount point: ~/ASSIMILATE
                        > encryption: repokey-blake2-chacha20-poly1305
                        > compression: zstd,1
                        > passcommand: echo "roadhouse pause govern parry"
                        > report_diffs_cmd: diff -r --suppress-common-lines -x '.local'
                        >
                        > prune_after_create: 'yes
                        > check_after_create: 'latest
                        > compact_after_delete: 'yes
                        >
                        > exclude if present: .nobackup
                        > exclude caches: 'yes
                        > exclude nodump: 'yes
                        >
                        > keep within: 1d
                        > keep hourly: 0
                        > keep daily: 7
                        > keep weekly: 4
                        > keep monthly: 6
                        > keep yearly: 0

                ~/.config/assimilate/test1.conf.nt:
                    contents:
                        > repository: ~/REPO/{config_name}
                        > archive: {config_name}
                        > match archives: id:{config_name}
                        > patterns:
                        >     - R ~
                        >     - - ~/.cache
                        >     - - ~/.local
                        >     - - ~/bu
                        >     - - ~/REPO

                ~/.config/assimilate/test2.conf.nt:
                    contents:
                        > repository: ~/REPO/{config_name}
                        > archive: {config_name}
                        > match archives: id:{config_name}
                        > patterns:
                        >     - R ~
                        >     - - ~/.cache
                        >     - - ~/.local
                        >     - - ~/bu
                        >     - - ~/REPO

                ~/REPO/:

                ~/a:
                    contents: aaa
                    mtime: 2024-11-27

                ~/b:
                    contents: bbb
                    mtime: 2024-11-26

        tests:
            tundra — repo-create {{{2:
                run: assimilate repo-create
                checks:
                    stdout:
                        contains text: Reserve some repository storage space now for emergencies

                    stderr:
                        matches text:
                            > === test1 ===
                            >
                            > === test2 ===

                    ~/.local/share/assimilate/test1.log:
                        contains text:
                            > running:
                            >     borg \
                            >         repo-create \
                            >         --repo=/{run_dir}/REPO/test1 \
                            >         --make-parent-dirs \
                            >         --encryption=repokey-blake2-chacha20-poly1305

                    ~/.local/share/assimilate/test1.log.nt:
                        contains lines in order:
                            -     > running command: repo-create
                            -

                    ~/.local/share/assimilate/test2.log:
                        contains text:
                            > running:
                            >     borg \
                            >         repo-create \
                            >         --repo=/{run_dir}/REPO/test2 \
                            >         --make-parent-dirs \
                            >         --encryption=repokey-blake2-chacha20-poly1305

                    ~/.local/share/assimilate/test2.log.nt:
                        contains lines in order:
                            -     > running command: repo-create
                            -

            disengage — due {{{2:
                run: assimilate due
                checks:
                    stdout:
                        matches text:
                            > test1 backup never run.
                            > test1 compact never run.
                            > test1 check never run.
                            >
                            > test2 backup never run.
                            > test2 compact never run.
                            > test2 check never run.

                    ~/.local/share/assimilate/test1.log.nt:
                        excludes line:     > running command: due

                    ~/.local/share/assimilate/test2.log.nt:
                        excludes line:     > running command: due

            gradient — create {{{2:
                run: assimilate create
                checks:
                    stderr:
                        matches text:
                            > === test1 ===
                            >
                            > === test2 ===

                    ~/.local/share/assimilate/test1.log:
                        contains text:
                            > Borg-related environment variables: {{
                            >     'BORG_PASSCOMMAND': 'echo "roadhouse pause govern parry"',
                            > }}
                        contains text:
                            > running:
                            >     borg \
                            >         create \
                            >         --repo=/{run_dir}/REPO/test1 \
                            >         '--pattern=R /{run_dir}' \
                            >         '--pattern=- /{run_dir}/.cache' \
                            >         '--pattern=- /{run_dir}/.local' \
                            >         '--pattern=- /{run_dir}/bu' \
                            >         '--pattern=- /{run_dir}/REPO' \
                            >         --stats \
                            >         --compression=zstd,1 \
                            >         --exclude-caches \
                            >         --exclude-nodump \
                            >         --exclude-if-present=.nobackup \
                            >         test1
                        contains text:
                            > running:
                            >     borg \
                            >         check \
                            >         --last=1 \
                            >         --repo=/{run_dir}/REPO/test1 \
                            >         --match-archives=sh:test1
                        contains text:
                            > running:
                            >     borg \
                            >         prune \
                            >         --repo=/{run_dir}/REPO/test1 \
                            >         --keep-within=1d \
                            >         --keep-daily=7 \
                            >         --keep-weekly=4 \
                            >         --keep-monthly=6 \
                            >         --match-archives=sh:test1
                        contains text:
                            > running:
                            >     borg \
                            >         compact \
                            >         --repo=/{run_dir}/REPO/test1

                    ~/.local/share/assimilate/test1.log.nt:
                        contains lines in order:
                            -     > running command: create
                            -

                    ~/.local/share/assimilate/test1.latest.nt:
                        contains regex: ^create last run: \d\d\d\d-\d\d-\d\dT\d\d:\d\d:\d\d.*$

                    ~/.local/share/assimilate/test2.log:
                        contains text:
                            > Borg-related environment variables: {{
                            >     'BORG_PASSCOMMAND': 'echo "roadhouse pause govern parry"',
                            > }}
                        contains text:
                            > running:
                            >     borg \
                            >         create \
                            >         --repo=/{run_dir}/REPO/test2 \
                            >         '--pattern=R /{run_dir}' \
                            >         '--pattern=- /{run_dir}/.cache' \
                            >         '--pattern=- /{run_dir}/.local' \
                            >         '--pattern=- /{run_dir}/bu' \
                            >         '--pattern=- /{run_dir}/REPO' \
                            >         --stats \
                            >         --compression=zstd,1 \
                            >         --exclude-caches \
                            >         --exclude-nodump \
                            >         --exclude-if-present=.nobackup \
                            >         test2
                        contains text:
                            > running:
                            >     borg \
                            >         check \
                            >         --last=1 \
                            >         --repo=/{run_dir}/REPO/test2 \
                            >         --match-archives=sh:test2
                        contains text:
                            > running:
                            >     borg \
                            >         prune \
                            >         --repo=/{run_dir}/REPO/test2 \
                            >         --keep-within=1d \
                            >         --keep-daily=7 \
                            >         --keep-weekly=4 \
                            >         --keep-monthly=6 \
                            >         --match-archives=sh:test2
                        contains text:
                            > running:
                            >     borg \
                            >         compact \
                            >         --repo=/{run_dir}/REPO/test2

                    ~/.local/share/assimilate/test2.log.nt:
                        contains lines in order:
                            -     > running command: create
                            -

                    ~/.local/share/assimilate/test2.latest.nt:
                        contains regex: ^create last run: \d\d\d\d-\d\d-\d\dT\d\d:\d\d:\d\d.*$

            cornfield — create again {{{2:
                initialization:
                    remove: ~/b
                    create:
                        ~/c:
                            contents: ccc
                            mtime: 2024-11-28
                run: assimilate -q
                checks:
                    ~/.local/share/assimilate/test1.log:
                        contains text:
                            > running:
                            >     borg \
                            >         create \
                            >         --repo=/{run_dir}/REPO/test1 \
                            >         '--pattern=R /{run_dir}' \
                            >         '--pattern=- /{run_dir}/.cache' \
                            >         '--pattern=- /{run_dir}/.local' \
                            >         '--pattern=- /{run_dir}/bu' \
                            >         '--pattern=- /{run_dir}/REPO' \
                            >         --stats \
                            >         --compression=zstd,1 \
                            >         --exclude-caches \
                            >         --exclude-nodump \
                            >         --exclude-if-present=.nobackup \
                            >         test1
                        contains text:
                            > running:
                            >     borg \
                            >         check \
                            >         --last=1 \
                            >         --repo=/{run_dir}/REPO/test1 \
                            >         --match-archives=sh:test1
                        contains text:
                            > running:
                            >     borg \
                            >         prune \
                            >         --repo=/{run_dir}/REPO/test1 \
                            >         --keep-within=1d \
                            >         --keep-daily=7 \
                            >         --keep-weekly=4 \
                            >         --keep-monthly=6 \
                            >         --match-archives=sh:test1
                        contains text:
                            > running:
                            >     borg \
                            >         compact \
                            >         --repo=/{run_dir}/REPO/test1

                    ~/.local/share/assimilate/test1.log.nt:
                        contains lines in order:
                            -     > running command: create
                            -

                    ~/.local/share/assimilate/test1.latest.nt:
                        contains regex: ^create last run: \d\d\d\d-\d\d-\d\dT\d\d:\d\d:\d\d.*$

                    ~/.local/share/assimilate/test2.log:
                        contains text:
                            > running:
                            >     borg \
                            >         create \
                            >         --repo=/{run_dir}/REPO/test2 \
                            >         '--pattern=R /{run_dir}' \
                            >         '--pattern=- /{run_dir}/.cache' \
                            >         '--pattern=- /{run_dir}/.local' \
                            >         '--pattern=- /{run_dir}/bu' \
                            >         '--pattern=- /{run_dir}/REPO' \
                            >         --stats \
                            >         --compression=zstd,1 \
                            >         --exclude-caches \
                            >         --exclude-nodump \
                            >         --exclude-if-present=.nobackup \
                            >         test2
                        contains text:
                            > running:
                            >     borg \
                            >         check \
                            >         --last=1 \
                            >         --repo=/{run_dir}/REPO/test2 \
                            >         --match-archives=sh:test2
                        contains text:
                            > running:
                            >     borg \
                            >         prune \
                            >         --repo=/{run_dir}/REPO/test2 \
                            >         --keep-within=1d \
                            >         --keep-daily=7 \
                            >         --keep-weekly=4 \
                            >         --keep-monthly=6 \
                            >         --match-archives=sh:test2
                        contains text:
                            > running:
                            >     borg \
                            >         compact \
                            >         --repo=/{run_dir}/REPO/test2

                    ~/.local/share/assimilate/test2.log.nt:
                        contains lines in order:
                            -     > running command: create
                            -

                    ~/.local/share/assimilate/test2.latest.nt:
                        contains regex: ^create last run: \d\d\d\d-\d\d-\d\dT\d\d:\d\d:\d\d.*$

            snobby — repo-list {{{2:
                run: assimilate repo-list
                checks:
                    stdout:
                        matches regex:
                            > 1   aid:(?P<aid1>\w+)  (?P<ar1>[^ ]+)   .*
                            > 0   aid:(?P<aid0>\w+)  (?P<ar0>[^ ]+)   .*

                    ~/.local/share/assimilate/test1.log:
                        contains text:
                            > running:
                            >     borg \
                            >         repo-list \
                            >         --json \
                            >         --repo=/{run_dir}/REPO/test1 \
                            >         --match-archives=sh:test1

                    ~/.local/share/assimilate/test1.log.nt:
                        contains lines in order:
                            -     > running command: repo-list
                            -

            uncoil — repo-space {{{2:
                run: assimilate repo-space --reserve=1MiB
                checks:
                    stdout:
                        contains regex:
                            > There is [0-9.]+ MB reserved space in this repository now.

                    stderr:
                        matches text:
                            > === test1 ===
                            >
                            > === test2 ===

                    ~/.local/share/assimilate/test1.log:
                        contains text:
                            > running:
                            >     borg \
                            >         repo-space \
                            >         --reserve=1048576 \
                            >         --repo=/{run_dir}/REPO/test1

                    ~/.local/share/assimilate/test1.log.nt:
                        contains lines in order:
                            -     > running command: repo-space
                            -

                    ~/.local/share/assimilate/test2.log:
                        contains text:
                            > running:
                            >     borg \
                            >         repo-space \
                            >         --reserve=1048576 \
                            >         --repo=/{run_dir}/REPO/test2

                    ~/.local/share/assimilate/test2.log.nt:
                        contains lines in order:
                            -     > running command: repo-space
                            -

            doggie — repo-space {{{2:
                run: assimilate repo-space --free
                checks:
                    stderr:
                        contains text:
                            > === test1 ===
                            >
                            > === test2 ===

                    stdout:
                        contains regex:
                            > Freed [0-9.]+ MB in repository.
                            > Now run borg prune or borg delete plus borg compact to free more space.
                            > After that, do not forget to reserve space again for next time!
                            > Freed [0-9.]+ MB in repository.
                            > Now run borg prune or borg delete plus borg compact to free more space.
                            > After that, do not forget to reserve space again for next time!

                    ~/.local/share/assimilate/test1.log:
                        contains text:
                            > running:
                            >     borg \
                            >         repo-space \
                            >         --free \
                            >         --repo=/{run_dir}/REPO/test1

                    ~/.local/share/assimilate/test1.log.nt:
                        contains lines in order:
                            -     > running command: repo-space
                            -

                    ~/.local/share/assimilate/test2.log:
                        contains text:
                            > running:
                            >     borg \
                            >         repo-space \
                            >         --free \
                            >         --repo=/{run_dir}/REPO/test2

                    ~/.local/share/assimilate/test2.log.nt:
                        contains lines in order:
                            -     > running command: repo-space
                            -

            embassy — info {{{2:
                run: assimilate info
                checks:
                    stdout:
                        contains regex:
                            >               config: test1
                            >                roots: /{run_dir}
                            >          destination: /{run_dir}/REPO/test1
                            >   settings directory: /{run_dir}/.config/assimilate
                            >              logfile: /{run_dir}/.local/share/assimilate/test1.log
                            >      create last run: .*
                            >       prune last run: .*
                            >     compact last run: .*
                            >       check last run: .*
                        contains regex:
                            > Repository ID: [a-f0-9]+
                            > Location: /{run_dir}/REPO/test1
                            > Repository version: 3
                            > Append only: False
                            > Encrypted: Yes \(repokey BLAKE2b ChaCha20-Poly1305\)
                            > Storage quota: 0 B used
                            > Cache: /{run_dir}/.cache/borg/[a-f0-9]+
                            > Security dir: /{run_dir}/.local/share/borg/security/[a-f0-9]+

                    stderr:
                        matches text:
                            > === test1 ===
                            >
                            > === test2 ===

                    ~/.local/share/assimilate/test1.log:
                        contains text:
                            > running:
                            >     borg \
                            >         repo-info \
                            >         --repo=/{run_dir}/REPO/test1

                    ~/.local/share/assimilate/test1.log.nt:
                        contains lines in order:
                            -     > running command: info
                            -

            faucet — list {{{2:
                run: assimilate list
                checks:
                    stdout:
                        contains lines:
                            - {run_dir}/
                            - {run_dir}/.config/
                            - {run_dir}/.config/assimilate/
                            - {run_dir}/.config/assimilate/shared.conf.nt
                            - {run_dir}/.config/assimilate/test1.conf.nt
                            - {run_dir}/.config/assimilate/test2.conf.nt
                            - {run_dir}/a
                            - {run_dir}/c

                    stderr:
                        matches regex:
                            > archive: {aid0} {ar0} .*

                    ~/.local/share/assimilate/test1.log:
                        contains text:
                            > running:
                            >     borg \
                            >         repo-list \
                            >         --repo=/{run_dir}/REPO/test1 \
                            >         --match-archives=sh:test1 \
                            >         --json \
                            >         --last=1
                        contains text:
                            > running:
                            >     borg \
                            >         list \
                            >         --repo=/{run_dir}/REPO/test1 \
                            >         --json-lines \
                            >         '--format={{path}}{{type}}' \
                            >         aid:{aid0}

                    ~/.local/share/assimilate/test1.log.nt:
                        contains lines in order:
                            -     > running command: list
                            -

            embitter — list {{{2:
                run: assimilate list -a aid:{aid1}
                checks:
                    stdout:
                        contains lines:
                            - {run_dir}/
                            - {run_dir}/.config/
                            - {run_dir}/.config/assimilate/
                            - {run_dir}/.config/assimilate/shared.conf.nt
                            - {run_dir}/.config/assimilate/test1.conf.nt
                            - {run_dir}/.config/assimilate/test2.conf.nt
                            - {run_dir}/a
                            - {run_dir}/b

                    ~/.local/share/assimilate/test1.log:
                        contains text:
                            > running:
                            >     borg \
                            >         list \
                            >         --repo=/{run_dir}/REPO/test1 \
                            >         --json-lines \
                            >         '--format={{path}}{{type}}' \
                            >         aid:{aid1}

                    ~/.local/share/assimilate/test1.log.nt:
                        contains lines in order:
                            -     > running command: list
                            -

            tyrant — break-lock {{{2:
                # there is no lock to break, but exercise the command anyway
                run: assimilate break-lock
                checks:
                    stderr:
                        matches text: assimilate error: test: command does not support composite configs.

                    status: 2

            sheepdog — prune {{{2:
                run: assimilate prune
                checks:
                    stderr:
                        matches text:
                            > === test1 ===
                            >
                            > === test2 ===

                    ~/.local/share/assimilate/test1.log:
                        contains text:
                            > running:
                            >     borg \
                            >         prune \
                            >         --repo=/{run_dir}/REPO/test1 \
                            >         --keep-within=1d \
                            >         --keep-daily=7 \
                            >         --keep-weekly=4 \
                            >         --keep-monthly=6 \
                            >         --match-archives=sh:test1
                        contains text:
                            > running:
                            >     borg \
                            >         compact \
                            >         --repo=/{run_dir}/REPO/test1

                    ~/.local/share/assimilate/test1.log.nt:
                        contains lines in order:
                            -     > running command: prune
                            -

                    ~/.local/share/assimilate/test1.latest.nt:
                        contains regex: ^prune last run: \d\d\d\d-\d\d-\d\dT\d\d:\d\d:\d\d.*$

                    ~/.local/share/assimilate/test2.log:
                        contains text:
                            > running:
                            >     borg \
                            >         prune \
                            >         --repo=/{run_dir}/REPO/test2 \
                            >         --keep-within=1d \
                            >         --keep-daily=7 \
                            >         --keep-weekly=4 \
                            >         --keep-monthly=6 \
                            >         --match-archives=sh:test2
                        contains text:
                            > running:
                            >     borg \
                            >         compact \
                            >         --repo=/{run_dir}/REPO/test2

                    ~/.local/share/assimilate/test2.log.nt:
                        contains lines in order:
                            -     > running command: prune
                            -

                    ~/.local/share/assimilate/test2.latest.nt:
                        contains regex: ^prune last run: \d\d\d\d-\d\d-\d\dT\d\d:\d\d:\d\d.*$

            smile — compact {{{2:
                run: assimilate compact
                checks:
                    stderr:
                        matches text:
                            > === test1 ===
                            >
                            > === test2 ===

                    ~/.local/share/assimilate/test1.log:
                        contains text:
                            > running:
                            >     borg \
                            >         compact \
                            >         --repo=/{run_dir}/REPO/test1

                    ~/.local/share/assimilate/test1.log.nt:
                        contains lines in order:
                            -     > running command: compact
                            -

                    ~/.local/share/assimilate/test1.latest.nt:
                        contains regex: ^compact last run: \d\d\d\d-\d\d-\d\dT\d\d:\d\d:\d\d.*$

                    ~/.local/share/assimilate/test2.log:
                        contains text:
                            > running:
                            >     borg \
                            >         compact \
                            >         --repo=/{run_dir}/REPO/test2

                    ~/.local/share/assimilate/test2.log.nt:
                        contains lines in order:
                            -     > running command: compact
                            -

                    ~/.local/share/assimilate/test2.latest.nt:
                        contains regex: ^compact last run: \d\d\d\d-\d\d-\d\dT\d\d:\d\d:\d\d.*$


            slice — check {{{2:
                run: assimilate check --verify-data
                checks:
                    stderr:
                        matches regex:
                            > === test1 ===
                            >
                            > === test2 ===

                    ~/.local/share/assimilate/test1.log:
                        contains text:
                            > running:
                            >     borg \
                            >         check \
                            >         --last=1 \
                            >         --repo=/{run_dir}/REPO/test1 \
                            >         --match-archives=sh:test1 \
                            >         --verify-data

                    ~/.local/share/assimilate/test2.log:
                        contains text:
                            > running:
                            >     borg \
                            >         check \
                            >         --last=1 \
                            >         --repo=/{run_dir}/REPO/test2 \
                            >         --match-archives=sh:test2 \
                            >         --verify-data

                    ~/.local/share/assimilate/test1.log.nt:
                        contains text:
                            >     > running:
                            >     >     borg \
                            >     >         check \
                            >     >         --last=1 \
                            >     >         --repo=/{run_dir}/REPO/test1 \
                            >     >         --match-archives=sh:test1 \
                            >     >         --verify-data

                    ~/.local/share/assimilate/test2.log.nt:
                        contains text:
                            >     > running:
                            >     >     borg \
                            >     >         check \
                            >     >         --last=1 \
                            >     >         --repo=/{run_dir}/REPO/test2 \
                            >     >         --match-archives=sh:test2 \
                            >     >         --verify-data

                    ~/.local/share/assimilate/test1.latest.nt:
                        contains regex: ^check last run: \d\d\d\d-\d\d-\d\dT\d\d:\d\d:\d\d.*$


            trestle — compare {{{2:
                run: assimilate compare
                checks:
                    stdout:
                        contains lines:
                            - Only in .: ASSIMILATE
                            - Only in .: bu
                            - Only in .: .cache
                            - Only in .: REPO

                    stderr:
                        matches regex:
                            > archive: {aid0} {ar0} .*

                    status: 1

            avowal — compare -a {{{2:
                run: assimilate compare -a aid:{aid1}
                checks:
                    stdout:
                        contains lines:
                            - Only in .: ASSIMILATE
                            - Only in /{run_dir}/ASSIMILATE/{ar1}/{run_dir}: b
                            - Only in .: bu
                            - Only in .: c
                            - Only in .: .cache
                            - Only in .: REPO
                    status: 1

            kilogram — diff {{{2:
                run: assimilate diff aid:{aid1} aid:{aid0}
                checks:
                    stderr:
                        matches text: assimilate error: test: command does not support composite configs.
                    status: 2

            happy — configs {{{2:
                run: assimilate configs
                checks:
                    stdout:
                        matches text:
                            > Available Configurations:
                            >     test = test1, test2
                            >     test1
                            >     test2
                            >
                            > Default Configuration:
                            >     test

            economize — mount {{{2:
                run: assimilate mount
                checks:
                    stderr:
                        matches regex: mount point is: /{run_dir}/ASSIMILATE

                    ~/.local/share/assimilate/test1.log:
                        contains text:
                            > running:
                            >     borg \
                            >         mount \
                            >         --repo=/{run_dir}/REPO/test1 \
                            >         --match-archives=sh:test1 \
                            >         /{run_dir}/ASSIMILATE

                    ~/.local/share/assimilate/test1.log.nt:
                        contains text:
                            >     > running:
                            >     >     borg \
                            >     >         mount \
                            >     >         --repo=/{run_dir}/REPO/test1 \
                            >     >         --match-archives=sh:test1 \
                            >     >         /{run_dir}/ASSIMILATE

                    ~/.local/share/assimilate/test2.log:
                        excludes line: running command: mount

                    ~/.local/share/assimilate/test2.log.nt:
                        excludes line:     > running command: mount

                    ~/ASSIMILATE/{ar1}-{aid1}/{run_dir}/a:
                        matches text: aaa

                    ~/ASSIMILATE/{ar1}-{aid1}/{run_dir}/b:
                        matches text: bbb

                    ~/ASSIMILATE/{ar0}-{aid0}/{run_dir}/a:
                        matches text: aaa

            fusspot — umount {{{2:
                run: assimilate umount
                checks:
                    ~/.local/share/assimilate/test1.log:
                        contains text:
                            > running:
                            >     borg \
                            >         umount \
                            >         --repo=/{run_dir}/REPO/test1 \
                            >         /{run_dir}/ASSIMILATE

                    ~/.local/share/assimilate/test1.log.nt:
                        contains lines in order:
                            -     > running command: umount
                            -

            portico — restore {{{2:
                run: assimilate restore -a aid:{aid1} b
                checks:
                    ~/b:
                        matches text: bbb

            backlog — extract {{{2:
                run: assimilate extract -a aid:{aid1} {run_dir}/a
                checks:
                    ~/{run_dir}/a:
                        matches text: aaa

            uprise — extract {{{2:
                run: assimilate extract -a aid:{aid1} /{run_dir}/b
                checks:
                    ~/{run_dir}/b:
                        matches text: bbb

            shrew — delete {{{2:
                initialization:
                    remove: ~/.local/share/assimilate/test1.latest.nt
                run: assimilate -c test1 delete -a aid:{aid1}
                checks:
                    ~/.local/share/assimilate/test1.log:
                        contains text:
                            > running:
                            >     borg \
                            >         delete \
                            >         --match-archives=aid:{aid1} \
                            >         --repo=/{run_dir}/REPO/test1
                        contains text:
                            > running:
                            >     borg \
                            >         compact \
                            >         --repo=/{run_dir}/REPO/test1

                    ~/.local/share/assimilate/test1.log.nt:
                        contains lines in order:
                            -     > running command: delete
                            -

                    ~/.local/share/assimilate/test1.latest.nt:
                        matches regex: ^compact last run: \d\d\d\d-\d\d-\d\dT\d\d:\d\d:\d\d.*$

            aspire — repo-list {{{2:
                run: assimilate repo-list
                checks:
                    stdout:
                        matches regex:
                            > 0   aid:(?P<aid0>\w+)  (?P<ar0>[^ ]+)   .*

                    ~/.local/share/assimilate/test1.log:
                        contains text:
                            > running:
                            >     borg \
                            >         repo-list \
                            >         --json \
                            >         --repo=/{run_dir}/REPO/test1 \
                            >         --match-archives=sh:test1

                    ~/.local/share/assimilate/test1.log.nt:
                        contains lines in order:
                            -     > running command: repo-list
                            -

                    ~/.local/share/assimilate/test2.log:
                        excludes line: running command: repo-list - fuxme

                    ~/.local/share/assimilate/test2.log.nt:
                        excludes line: > running command: repo-list

            impeach — log {{{2:
                run: assimilate log
                checks:
                    stdout:
                        contains regex:
                            > aid:{aid0}  {ar0}   .*

                    stderr:
                        matches text:
                            > === test1 ===
                            >
                            > === test2 ===


            crawler — borg repo-list {{{2:
                run: assimilate borg --repo @repo repo-list
                checks:
                    stderr:
                        matches text: assimilate error: test: command does not support composite configs.
                    status: 2

    hornet — single config, implicit archive, filter options {{{1:
        initialization:
            create:
                ~/.config/assimilate/shared.conf.nt:
                    contents:
                        > default config: test
                        > encryption: none

                ~/REPO/:

                ~/.config/assimilate/test.conf.nt:
                    contents:
                        > repository: ~/REPO/{config_name}
                        > archive: {config_name}
                        > match archives: id:{config_name}
                        > patterns:
                        >     - R ~
                        >     - - ~/.cache
                        >     - - ~/.local
                        >     - - ~/bu
                        >     - - ~/REPO

                ~/a:
                    contents:
                        > aaa
                    mtime: 2024-11-27

                ~/b:
                    contents:
                        > bbb
                    mtime: 2024-11-26

        tests:
            pantry — repo-create {{{2:
                run: assimilate repo-create
                checks:
                    stdout:
                        contains text: Reserve some repository storage space now for emergencies

                    ~/.local/share/assimilate/test.log:
                        contains text:
                            > running:
                            >     borg \
                            >         repo-create \
                            >         --repo=/{run_dir}/REPO/test \
                            >         --make-parent-dirs \
                            >         --encryption=none

                    ~/.local/share/assimilate/test.log.nt:
                        contains lines in order:
                            -     > running command: repo-create
                            -

            roster — create {{{2:
                run: assimilate create
                checks:
                    ~/.local/share/assimilate/test.log:
                        contains text:
                            > running:
                            >     borg \
                            >         create \
                            >         --repo=/{run_dir}/REPO/test \
                            >         '--pattern=R /{run_dir}' \
                            >         '--pattern=- /{run_dir}/.cache' \
                            >         '--pattern=- /{run_dir}/.local' \
                            >         '--pattern=- /{run_dir}/bu' \
                            >         '--pattern=- /{run_dir}/REPO' \
                            >         --stats \
                            >         test
                        excludes text: check
                        excludes text: prune
                        excludes text: compact

                    ~/.local/share/assimilate/test.log.nt:
                        contains lines in order:
                            -     > running command: create
                            -

                    ~/.local/share/assimilate/test.latest.nt:
                        contains regex: ^create last run: \d\d\d\d-\d\d-\d\dT\d\d:\d\d:\d\d.*$

            trundle — create again {{{2:
                run: assimilate
                checks:
                    ~/.local/share/assimilate/test.log:
                        contains text:
                            > running:
                            >     borg \
                            >         create \
                            >         --repo=/{run_dir}/REPO/test \
                            >         '--pattern=R /{run_dir}' \
                            >         '--pattern=- /{run_dir}/.cache' \
                            >         '--pattern=- /{run_dir}/.local' \
                            >         '--pattern=- /{run_dir}/bu' \
                            >         '--pattern=- /{run_dir}/REPO' \
                            >         --stats \
                            >         test
                        excludes text: check
                        excludes text: prune
                        excludes text: compact

                    ~/.local/share/assimilate/test.log.nt:
                        contains lines in order:
                            -     > running command: create
                            -

                    ~/.local/share/assimilate/test.latest.nt:
                        contains regex: ^create last run: \d\d\d\d-\d\d-\d\dT\d\d:\d\d:\d\d.*$

            marginal — create again² {{{2:
                run: assimilate
                checks:
                    ~/.local/share/assimilate/test.log:
                        contains text:
                            > running:
                            >     borg \
                            >         create \
                            >         --repo=/{run_dir}/REPO/test \
                            >         '--pattern=R /{run_dir}' \
                            >         '--pattern=- /{run_dir}/.cache' \
                            >         '--pattern=- /{run_dir}/.local' \
                            >         '--pattern=- /{run_dir}/bu' \
                            >         '--pattern=- /{run_dir}/REPO' \
                            >         --stats \
                            >         test
                        excludes text: check
                        excludes text: prune
                        excludes text: compact

                    ~/.local/share/assimilate/test.log.nt:
                        contains lines in order:
                            -     > running command: create
                            -

                    ~/.local/share/assimilate/test.latest.nt:
                        contains regex: ^create last run: \d\d\d\d-\d\d-\d\dT\d\d:\d\d:\d\d.*$

            mistress — create again³ {{{2:
                run: assimilate
                checks:
                    ~/.local/share/assimilate/test.log:
                        contains text:
                            > running:
                            >     borg \
                            >         create \
                            >         --repo=/{run_dir}/REPO/test \
                            >         '--pattern=R /{run_dir}' \
                            >         '--pattern=- /{run_dir}/.cache' \
                            >         '--pattern=- /{run_dir}/.local' \
                            >         '--pattern=- /{run_dir}/bu' \
                            >         '--pattern=- /{run_dir}/REPO' \
                            >         --stats \
                            >         test
                        excludes text: check
                        excludes text: prune
                        excludes text: compact

                    ~/.local/share/assimilate/test.log.nt:
                        contains lines in order:
                            -     > running command: create
                            -

                    ~/.local/share/assimilate/test.latest.nt:
                        contains regex: ^create last run: \d\d\d\d-\d\d-\d\dT\d\d:\d\d:\d\d.*$

            hangman — create again⁴ {{{2:
                run: assimilate
                checks:
                    ~/.local/share/assimilate/test.log:
                        contains text:
                            > running:
                            >     borg \
                            >         create \
                            >         --repo=/{run_dir}/REPO/test \
                            >         '--pattern=R /{run_dir}' \
                            >         '--pattern=- /{run_dir}/.cache' \
                            >         '--pattern=- /{run_dir}/.local' \
                            >         '--pattern=- /{run_dir}/bu' \
                            >         '--pattern=- /{run_dir}/REPO' \
                            >         --stats \
                            >         test
                        excludes text: check
                        excludes text: prune
                        excludes text: compact

                    ~/.local/share/assimilate/test.log.nt:
                        contains lines in order:
                            -     > running command: create
                            -

                    ~/.local/share/assimilate/test.latest.nt:
                        contains regex: ^create last run: \d\d\d\d-\d\d-\d\dT\d\d:\d\d:\d\d.*$

            larder — repo-list {{{2:
                run: assimilate repo-list
                checks:
                    stdout:
                        matches regex:
                            > 4   aid:(?P<aid4>\w+)  (?P<ar4>[^ ]+)   .*
                            > 3   aid:(?P<aid3>\w+)  (?P<ar3>[^ ]+)   .*
                            > 2   aid:(?P<aid2>\w+)  (?P<ar2>[^ ]+)   .*
                            > 1   aid:(?P<aid1>\w+)  (?P<ar1>[^ ]+)   .*
                            > 0   aid:(?P<aid0>\w+)  (?P<ar0>[^ ]+)   .*

                    ~/.local/share/assimilate/test.log:
                        contains text:
                            > running:
                            >     borg \
                            >         repo-list \
                            >         --oldest=1440m \
                            >         --json \
                            >         --repo=/{run_dir}/REPO/test \
                            >         --match-archives=sh:test

            indicate — repo-list --first=3 {{{2:
                run: assimilate repo-list --first=3
                checks:
                    stdout:
                        matches regex:
                            > aid:(?P<aid4>\w+)  (?P<ar4>[^ ]+)   .*
                            > aid:(?P<aid3>\w+)  (?P<ar3>[^ ]+)   .*
                            > aid:(?P<aid2>\w+)  (?P<ar2>[^ ]+)   .*

                    ~/.local/share/assimilate/test.log:
                        contains text:
                            > running:
                            >     borg \
                            >         repo-list \
                            >         --first=3 \
                            >         --json \
                            >         --repo=/{run_dir}/REPO/test \
                            >         --match-archives=sh:test

            stockroom — repo-list --last=3 {{{2:
                run: assimilate repo-list --last=3
                checks:
                    stdout:
                        matches regex:
                            > 2   aid:(?P<aid2>\w+)  (?P<ar2>[^ ]+)   .*
                            > 1   aid:(?P<aid1>\w+)  (?P<ar1>[^ ]+)   .*
                            > 0   aid:(?P<aid0>\w+)  (?P<ar0>[^ ]+)   .*

                    ~/.local/share/assimilate/test.log:
                        contains text:
                            > running:
                            >     borg \
                            >         repo-list \
                            >         --last=3 \
                            >         --json \
                            >         --repo=/{run_dir}/REPO/test \
                            >         --match-archives=sh:test

            larder — repo-list --oldest=1d {{{2:
                run: assimilate repo-list --oldest=1d
                checks:
                    stdout:
                        matches regex:
                            > aid:(?P<aid4>\w+)  (?P<ar4>[^ ]+)   .*
                            > aid:(?P<aid3>\w+)  (?P<ar3>[^ ]+)   .*
                            > aid:(?P<aid2>\w+)  (?P<ar2>[^ ]+)   .*
                            > aid:(?P<aid1>\w+)  (?P<ar1>[^ ]+)   .*
                            > aid:(?P<aid0>\w+)  (?P<ar0>[^ ]+)   .*

                    ~/.local/share/assimilate/test.log:
                        contains text:
                            > running:
                            >     borg \
                            >         repo-list \
                            >         --oldest=1440m \
                            >         --json \
                            >         --repo=/{run_dir}/REPO/test \
                            >         --match-archives=sh:test

            elevate — repo-list --newest=1d {{{2:
                run: assimilate repo-list --newest=1d
                checks:
                    stdout:
                        matches regex:
                            > aid:(?P<aid4>\w+)  (?P<ar4>[^ ]+)   .*
                            > aid:(?P<aid3>\w+)  (?P<ar3>[^ ]+)   .*
                            > aid:(?P<aid2>\w+)  (?P<ar2>[^ ]+)   .*
                            > aid:(?P<aid1>\w+)  (?P<ar1>[^ ]+)   .*
                            > aid:(?P<aid0>\w+)  (?P<ar0>[^ ]+)   .*

                    ~/.local/share/assimilate/test.log:
                        contains text:
                            > running:
                            >     borg \
                            >         repo-list \
                            >         --newest=1440m \
                            >         --json \
                            >         --repo=/{run_dir}/REPO/test \
                            >         --match-archives=sh:test

            wrongdoer — repo-list --older=1d {{{2:
                run: assimilate repo-list --older=1d
                checks:
                    stdout:
                        matches regex:

                    ~/.local/share/assimilate/test.log:
                        contains text:
                            > running:
                            >     borg \
                            >         repo-list \
                            >         --older=1440m \
                            >         --json \
                            >         --repo=/{run_dir}/REPO/test \
                            >         --match-archives=sh:test

            climb — repo-list --newer=1d {{{2:
                run: assimilate repo-list --newer=1d
                checks:
                    stdout:
                        matches regex:
                            > aid:(?P<aid4>\w+)  (?P<ar4>[^ ]+)   .*
                            > aid:(?P<aid3>\w+)  (?P<ar3>[^ ]+)   .*
                            > aid:(?P<aid2>\w+)  (?P<ar2>[^ ]+)   .*
                            > aid:(?P<aid1>\w+)  (?P<ar1>[^ ]+)   .*
                            > aid:(?P<aid0>\w+)  (?P<ar0>[^ ]+)   .*

                    ~/.local/share/assimilate/test.log:
                        contains text:
                            > running:
                            >     borg \
                            >         repo-list \
                            >         --newer=1440m \
                            >         --json \
                            >         --repo=/{run_dir}/REPO/test \
                            >         --match-archives=sh:test

            parade — list -a 4 {{{2:
                run: assimilate list -a 4
                checks:
                    stdout:
                        contains lines:
                            - {run_dir}/
                            - {run_dir}/.config/
                            - {run_dir}/.config/assimilate/
                            - {run_dir}/.config/assimilate/shared.conf.nt
                            - {run_dir}/.config/assimilate/test.conf.nt
                            - {run_dir}/a
                            - {run_dir}/b

                    stderr:
                        matches regex: archive: {aid4} {ar4} .*

                    ~/.local/share/assimilate/test.log:
                        contains text:
                            > running:
                            >     borg \
                            >         repo-list \
                            >         --repo=/{run_dir}/REPO/test
                        contains text:
                            > running:
                            >     borg \
                            >         list \
                            >         --repo=/{run_dir}/REPO/test

            expect — list -a 3 {{{2:
                run: assimilate list -a 3 .config
                checks:
                    stdout:
                        contains lines:
                            - {run_dir}/.config/
                            - {run_dir}/.config/assimilate/

                    stderr:
                        matches regex: archive: {aid3} {ar3} .*

                    ~/.local/share/assimilate/test.log:
                        contains text:
                            > running:
                            >     borg \
                            >         repo-list \
                            >         --repo=/{run_dir}/REPO/test
                        contains text:
                            > running:
                            >     borg \
                            >         list \
                            >         --repo=/{run_dir}/REPO/test

            gremlin — list -a 2 {{{2:
                run: assimilate list --archive 2 --recursive .config
                checks:
                    stdout:
                        contains lines:
                            - {run_dir}/.config/
                            - {run_dir}/.config/assimilate/
                            - {run_dir}/.config/assimilate/shared.conf.nt
                            - {run_dir}/.config/assimilate/test.conf.nt

                    stderr:
                        matches regex: archive: {aid2} {ar2} .*

                    ~/.local/share/assimilate/test.log:
                        contains text:
                            > running:
                            >     borg \
                            >         repo-list \
                            >         --repo=/{run_dir}/REPO/test
                        contains text:
                            > running:
                            >     borg \
                            >         list \
                            >         --repo=/{run_dir}/REPO/test

            tombola — list -a 1 {{{2:
                run: assimilate list -a 1
                checks:
                    stdout:
                        contains lines:
                            - {run_dir}/
                            - {run_dir}/.config/
                            - {run_dir}/.config/assimilate/
                            - {run_dir}/.config/assimilate/shared.conf.nt
                            - {run_dir}/.config/assimilate/test.conf.nt
                            - {run_dir}/a
                            - {run_dir}/b

                    stderr:
                        matches regex: archive: {aid1} {ar1} .*

                    ~/.local/share/assimilate/test.log:
                        contains text:
                            > running:
                            >     borg \
                            >         repo-list \
                            >         --repo=/{run_dir}/REPO/test
                        contains text:
                            > running:
                            >     borg \
                            >         list \
                            >         --repo=/{run_dir}/REPO/test

            partitive — list -a 0 {{{2:
                run: assimilate list -a 0
                checks:
                    stdout:
                        contains lines:
                            - {run_dir}/
                            - {run_dir}/.config/
                            - {run_dir}/.config/assimilate/
                            - {run_dir}/.config/assimilate/shared.conf.nt
                            - {run_dir}/.config/assimilate/test.conf.nt
                            - {run_dir}/a
                            - {run_dir}/b

                    stderr:
                        matches regex: archive: {aid0} {ar0} .*

                    ~/.local/share/assimilate/test.log:
                        contains text:
                            > running:
                            >     borg \
                            >         repo-list \
                            >         --repo=/{run_dir}/REPO/test
                        contains text:
                            > running:
                            >     borg \
                            >         list \
                            >         --repo=/{run_dir}/REPO/test

            outlet — mount ASSIMILATE {{{2:
                run: assimilate mount /{run_dir}/ASSIMILATE
                checks:
                    stderr:
                        matches regex: mount point is: /{run_dir}/ASSIMILATE

                    ~/.local/share/assimilate/test.log:
                        contains text:
                            > running:
                            >     borg \
                            >         mount \
                            >         --repo=/{run_dir}/REPO/test \
                            >         --match-archives=sh:test \
                            >         /{run_dir}/ASSIMILATE

                    ~/.local/share/assimilate/test.log.nt:
                        contains text:
                            >     > running:
                            >     >     borg \
                            >     >         mount \
                            >     >         --repo=/{run_dir}/REPO/test \
                            >     >         --match-archives=sh:test \
                            >     >         /{run_dir}/ASSIMILATE

                    ~/ASSIMILATE/test-{aid1}/{run_dir}/a:
                        matches text: aaa

                    ~/ASSIMILATE/test-{aid1}/{run_dir}/b:
                        matches text: bbb

                    ~/ASSIMILATE/test-{aid0}/{run_dir}/a:
                        matches text: aaa

            virtue — umount ASSIMILATE {{{2:
                run: assimilate umount /{run_dir}/ASSIMILATE

                checks:
                    ~/.local/share/assimilate/test.log.nt:
                        contains text:
                            >     > running:
                            >     >     borg \
                            >     >         umount \
                            >     >         --repo=/{run_dir}/REPO/test \
                            >     >         /{run_dir}/ASSIMILATE

    analytic — single config, src_dirs, relative working_dir {{{1:
        initialization:
            create:
                ~/.config/assimilate/shared.conf.nt:
                    contents:
                        > default config: test
                        > encryption: none
                        > working dir: ~
                        > check after create: 'all
                        > prune after create: 'yes
                        > compact after delete: 'yes
                        > keep_within: 1d

                ~/REPO/:

                ~/.config/assimilate/test.conf.nt:
                    contents:
                        > repository: ~/REPO/{config_name}
                        > archive: {config_name}
                        > src dirs: .
                        > excludes:
                        >     > .cache
                        >     > .local
                        >     > bu
                        >     > REPO

                ~/.config/assimilate/overdue.conf.nt:
                    contents:
                        > repositories:
                        >     test:
                        >         config: test

                ~/a:
                    contents:
                        > aaa
                    mtime: 2024-11-27

                ~/b:
                    contents:
                        > bbb
                    mtime: 2024-11-26

        tests:
            expatiate — run repo-list before repo exists {{{2:
                run: assimilate repo-list
                checks:
                    stderr:
                        contains regex: .*Repository.*does not exist.*

                    status: 2

            housemaid — run check before repo exists {{{2:
                run: assimilate check
                checks:
                    stderr:
                        contains regex: .*Repository.*does not exist.*

                    status: 2

            steal — run due before repo exists {{{2:
                run: assimilate due
                checks:
                    stderr:
                        contains text:
                            > assimilate error:
                            >     /{run_dir}/.local/share/assimilate/test.latest.nt: no such file or directory.
                    status: 2

            verity — run overdue before repo exists {{{2:
                run: assimilate overdue
                checks:
                    stderr:
                        contains text:
                            > assimilate error:
                            >     /{run_dir}/.local/share/assimilate/test.latest.nt: no such file or directory.

                    status: 2

            annual — repo-create {{{2:
                run: assimilate repo-create
                checks:
                    stdout:
                        contains text: Reserve some repository storage space now for emergencies

                    ~/.local/share/assimilate/test.log:
                        contains text:
                            > running:
                            >     borg \
                            >         repo-create \
                            >         --repo=/{run_dir}/REPO/test \
                            >         --make-parent-dirs \
                            >         --encryption=none


                    ~/.local/share/assimilate/test.log.nt:
                        contains lines in order:
                            -     > running command: repo-create
                            -

            sonnet — create --list {{{2:
                run: assimilate create --list
                checks:
                    stderr:
                        matches text:
                            >
                            > Running Borg create command ...
                            > - bu
                            > A .config/assimilate/shared.conf.nt
                            > A .config/assimilate/test.conf.nt
                            > A .config/assimilate/overdue.conf.nt
                            > d .config/assimilate
                            > d .config
                            > - REPO
                            > A a
                            > A b
                            > - .local
                            > - .cache
                            > d .

                    ~/.local/share/assimilate/test.log:
                        contains text:
                            > running:
                            >     borg \
                            >         check \
                            >         --last=1 \
                            >         --repo=/{run_dir}/REPO/test \
                            >         --match-archives=sh:test

                        contains text:
                            > running:
                            >     borg \
                            >         prune \
                            >         --repo=/{run_dir}/REPO/test \
                            >         --keep-within=1d \
                            >         --match-archives=sh:test

                        contains text:
                            > running:
                            >     borg \
                            >         compact \
                            >         --repo=/{run_dir}/REPO/test

            hectare — create --progress {{{2:
                run: assimilate create --progress
                checks:
                    stderr:
                        contains line:
                            > Running Borg create command ...

                    ~/.local/share/assimilate/test.log:
                        contains text:
                            > running:
                            >     borg \
                            >         create \
                            >         --progress \
                            >         --repo=/{run_dir}/REPO/test \
                            >         --exclude=.cache \
                            >         --exclude=.local \
                            >         --exclude=bu \
                            >         --exclude=REPO \
                            >         test \
                            >         .

                        contains text:
                            > running:
                            >     borg \
                            >         check \
                            >         --last=1 \
                            >         --repo=/{run_dir}/REPO/test \
                            >         --match-archives=sh:test

                        contains text:
                            > running:
                            >     borg \
                            >         prune \
                            >         --repo=/{run_dir}/REPO/test \
                            >         --keep-within=1d \
                            >         --match-archives=sh:test

                        contains text:
                            > running:
                            >     borg \
                            >         compact \
                            >         --repo=/{run_dir}/REPO/test

            malady — create --progress {{{2:
                run: assimilate create --stats
                checks:
                    stderr:
                        contains lines in order:
                            > Running Borg create command ...
                            > Repository: /{run_dir}/REPO/test
                            > Archive name: test

                    ~/.local/share/assimilate/test.log:
                        contains text:
                            > running:
                            >     borg \
                            >         create \
                            >         --repo=/{run_dir}/REPO/test \
                            >         --exclude=.cache \
                            >         --exclude=.local \
                            >         --exclude=bu \
                            >         --exclude=REPO \
                            >         --stats \
                            >         test \
                            >         .

                        contains text:
                            > running:
                            >     borg \
                            >         check \
                            >         --last=1 \
                            >         --repo=/{run_dir}/REPO/test \
                            >         --match-archives=sh:test

                        contains text:
                            > running:
                            >     borg \
                            >         prune \
                            >         --repo=/{run_dir}/REPO/test \
                            >         --keep-within=1d \
                            >         --match-archives=sh:test

                        contains text:
                            > running:
                            >     borg \
                            >         compact \
                            >         --repo=/{run_dir}/REPO/test

            warder — create --fast {{{2:
                run: assimilate create --fast
                checks:
                    ~/.local/share/assimilate/test.log:
                        excludes text: check
                        excludes text: prune

            piranha — repo-list {{{2:
                run: assimilate repo-list
                checks:
                    stdout:
                        matches regex:
                            > 3   aid:(?P<aid3>\w+)  (?P<ar3>[^ ]+)   .*
                            > 2   aid:(?P<aid2>\w+)  (?P<ar2>[^ ]+)   .*
                            > 1   aid:(?P<aid1>\w+)  (?P<ar1>[^ ]+)   .*
                            > 0   aid:(?P<aid0>\w+)  (?P<ar0>[^ ]+)   .*

            facial — repo-list {{{2:
                run: assimilate list
                checks:
                    stdout:
                        matches text:
                            > ./
                            > .config/
                            > .config/assimilate/
                            > .config/assimilate/shared.conf.nt
                            > .config/assimilate/test.conf.nt
                            > .config/assimilate/overdue.conf.nt
                            > a
                            > b

                    stderr:
                        matches regex:
                            > archive: {aid0} {ar0} .*
                            >
            softwood — check --repair  {{{2:
                run: assimilate check --repair
                checks:
                    ~/.local/share/assimilate/test.log:
                        contains text:
                            > running:
                            >     borg \
                            >         check \
                            >         --last=1 \
                            >         --repo=/{run_dir}/REPO/test \
                            >         --match-archives=sh:test \
                            >         --repair

                    ~/.local/share/assimilate/test.log.nt:
                        contains text:
                            >     > running:
                            >     >     borg \
                            >     >         check \
                            >     >         --last=1 \
                            >     >         --repo=/{run_dir}/REPO/test \
                            >     >         --match-archives=sh:test \
                            >     >         --repair

            vixen — check --verify-data  {{{2:
                run: assimilate check --verify-data
                checks:
                    ~/.local/share/assimilate/test.log:
                        contains text:
                            > running:
                            >     borg \
                            >         check \
                            >         --last=1 \
                            >         --repo=/{run_dir}/REPO/test \
                            >         --match-archives=sh:test

                    ~/.local/share/assimilate/test.log.nt:
                        contains text:
                            >     > running:
                            >     >     borg \
                            >     >         check \
                            >     >         --last=1 \
                            >     >         --repo=/{run_dir}/REPO/test \
                            >     >         --match-archives=sh:test


            valency — compact --progress  {{{2:
                run: assimilate compact --progress
                checks:
                    stderr:
                        contains line:
                            > Running Borg compact command ...

            canyon — delete  {{{2:
                run: assimilate delete -a aid:{aid3}
                checks:
                    ~/.local/share/assimilate/test.log:
                        contains text:
                            > running:
                            >     borg \
                            >         delete \
                            >         --match-archives=aid:{aid3} \
                            >         --repo=/{run_dir}/REPO/test

                        contains text:
                            > running:
                            >     borg \
                            >         compact \
                            >         --repo=/{run_dir}/REPO/test

            aubergine — delete --fast  {{{2:
                run: assimilate delete --fast -a aid:{aid2}
                checks:
                    ~/.local/share/assimilate/test.log:
                        contains text:
                            > running:
                            >     borg \
                            >         delete \
                            >         --match-archives=aid:{aid2} \
                            >         --repo=/{run_dir}/REPO/test
                        excludes text:   compact

            respond — due --since-backup ❬since❭ --message ❬msg❭ {{{2:
                run: assimilate due --since-backup 0  --message '{{config}}: {{cmd}} {{action}} {{since}} {{elapsed}}'
                checks:
                    stdout:
                        matches regex: ^test: backup backup 0d .*

                    status: 1

            agony — due --since-check ❬since❭ --message ❬msg❭ {{{2:
                run: assimilate due --since-check 0h  --message '{{config}}: {{cmd}} {{action}} {{since:0.1ph}} {{elapsed}}'
                checks:
                    stdout:
                        matches regex: ^test: check check 0h .*

                    status: 1

            resume — due --since-squeeze ❬since❭ --message ❬msg❭ {{{2:
                run: assimilate due --since-squeeze 0Y  --message '{{config}}: {{cmd}} {{action}} {{since:0.0ps}} {{elapsed}}'
                checks:
                    stdout:
                        matches regex: ^test: prune squeeze \d+s .*

                    status: 1

            paddy — extract --list .config {{{2:
                run: assimilate extract --list .config
                checks:
                    stderr:
                        matches regex:
                            > assimilate error:
                            >     Running from the working directory risks over writing the existing
                            >     file or files.  Use --force if this is desired.

                    status: 2

            ravage — extract --force --list .config {{{2:
                run: assimilate extract --force --list .config
                checks:
                    stderr:
                        matches regex:
                            > archive: {aid0} {ar0} .*
                            >
                            > Running Borg extract command \.\.\.
                            > \.config
                            > \.config/assimilate
                            > \.config/assimilate/shared\.conf\.nt
                            > \.config/assimilate/test\.conf\.nt
                            > \.config/assimilate/overdue\.conf\.nt

            embargo — restore --list .config {{{2:
                run: assimilate restore --list .config
                checks:
                    stderr:
                        matches regex:
                            > archive: {aid0} {ar0} .*
                            >
                            > Running Borg extract command \.\.\.
                            > \.config
                            > \.config/assimilate
                            > \.config/assimilate/shared\.conf\.nt
                            > \.config/assimilate/test\.conf\.nt
                            > \.config/assimilate/overdue\.conf\.nt

            tassel — prune --list  {{{2:
                run: assimilate prune --list
                checks:
                    stderr:
                        contains line: Running Borg prune command ...

                    ~/.local/share/assimilate/test.log:
                        contains text:
                            > running:
                            >     borg \
                            >         prune \
                            >         --list \
                            >         --repo=/{run_dir}/REPO/test \
                            >         --keep-within=1d \
                            >         --match-archives=sh:test

                        contains text:
                            > running:
                            >     borg \
                            >         compact \
                            >         --repo=/{run_dir}/REPO/test

            polyp — prune --stats  {{{2:
                run: assimilate prune --stats
                checks:
                    ~/.local/share/assimilate/test.log:
                        contains text:
                            > running:
                            >     borg \
                            >         prune \
                            >         --repo=/{run_dir}/REPO/test \
                            >         --keep-within=1d \
                            >         --match-archives=sh:test

                        contains text:
                            > running:
                            >     borg \
                            >         compact \
                            >         --repo=/{run_dir}/REPO/test

            chest — prune --fast  {{{2:
                run: assimilate prune --fast
                checks:
                    ~/.local/share/assimilate/test.log:
                        contains text:
                            > running:
                            >     borg \
                            >         prune \
                            >         --repo=/{run_dir}/REPO/test \
                            >         --keep-within=1d \
                            >         --match-archives=sh:test

                        excludes text: compact
                            # running:
                            #     borg \
                            #         compact \
                            #         --repo=/{run_dir}/REPO/test

            cannon — overdue {{{2:
                run: assimilate overdue
                checks:
                    stderr:
                        matches regex:
                            > test: .* ago

            locket — overdue --message {{{2:
                run: assimilate overdue --message="{{description}}\n{{max_age}}\n{{mtime}}\n{{age}}\n{{updated}}\n{{overdue:past due/up to date}}\n{{locked:active/not active}}"
                checks:
                    stderr:
                        matches regex:
                            > test
                            > 100800 s
                            > .*
                            > .*
                            > .*
                            > up to date
                            > not active

            closet — overdue {{{2:
                run: assimilate overdue --nt
                checks:
                    stdout:
                        matches regex:
                            > -
                            >     description: test
                            >     path: /{run_dir}/.local/share/assimilate/test.latest.nt
                            >     mtime: .*
                            >     age: .*
                            >     max_age: 100800 s
                            >     overdue: no
                            >     locked: no
                            >     updated: .*

            devotee — overdue {{{2:
                run: assimilate overdue --no-passes

            prism — overdue {{{2:
                run: assimilate --verbose overdue
                checks:
                    stderr:
                        matches regex:
                            > HOST: test
                            >     sentinel file: /{run_dir}/.local/share/assimilate/test.latest.nt
                            >     last modified: .*
                            >     since last change: .*
                            >     maximum age: 28 hours
                            >     overdue: no
                            >     locked: no

    retract — various list formats {{{1:
        initialization:
            create:
                ~/:
                    mtime: 2024-11-20T00:00:00

                ~/.config/:
                    mtime: 2024-11-21T00:00:00

                ~/.config/assimilate/:
                    mtime: 2024-11-22T00:00:00

                ~/.config/assimilate/shared.conf.nt:
                    contents:
                        > default config: test
                        > encryption: none
                    mtime: 2024-11-23T00:00:00

                ~/REPO/:

                ~/.config/assimilate/test.conf.nt:
                    contents:
                        > repository: ~/REPO/{config_name}
                        > patterns:
                        >     - R ~
                        >     - - ~/.cache
                        >     - - ~/.local
                        >     - - ~/bu
                        >     - - ~/REPO
                    mtime: 2024-11-24T00:00:00

                ~/a:
                    contents: !1000*'aaa\n'
                    mtime: 2024-11-27T00:00:00

                ~/b:
                    contents: !100_000*'bbb\n'
                    mtime: 2024-11-26T00:00:00

                ~/c:
                    contents: !10_000*'ccc\n'
                    mtime: 2024-11-25T00:00:00

        tests:
            crumb — repo-create {{{2:
                run: assimilate repo-create
                checks:
                    stdout:
                        contains text: Reserve some repository storage space now for emergencies

            decimate — create {{{2:
                initialization:
                    # reset the modification times for the directories
                    create:
                        ~/:
                            mtime: 2024-11-27T00:00:00

                        ~/.config/:
                            mtime: 2024-11-28T00:00:00

                        ~/.config/assimilate/:
                            mtime: 2024-11-29T00:00:00

                run: assimilate create

            chimera — list {{{2:
                run: assimilate list
                checks:
                    stderr:
                        matches regex: archive: .*

                    stdout:
                        matches text:
                            > {run_dir}/
                            > {run_dir}/.config/
                            > {run_dir}/.config/assimilate/
                            > {run_dir}/.config/assimilate/shared.conf.nt
                            > {run_dir}/.config/assimilate/test.conf.nt
                            > {run_dir}/a
                            > {run_dir}/b
                            > {run_dir}/c

            villager — list --short {{{2:
                run: assimilate list --short
                checks:
                    stderr:
                        matches regex: archive: .*

                    stdout:
                        matches text:
                            > {run_dir}/
                            > {run_dir}/.config/
                            > {run_dir}/.config/assimilate/
                            > {run_dir}/.config/assimilate/shared.conf.nt
                            > {run_dir}/.config/assimilate/test.conf.nt
                            > {run_dir}/a
                            > {run_dir}/b
                            > {run_dir}/c

            drowse — list --long {{{2:
                run: assimilate list --long
                checks:
                    stderr:
                        matches regex: archive: .*

                    stdout:
                        matches regex:
                            > drwx------ .+ 0 \d\d\d\d-\d\d-\d\dT\d\d:\d\d:\d\d.\d\d\d\d\d\d[+-]\d\d:\d\d {run_dir}
                            > drwx------ .+ 0 \d\d\d\d-\d\d-\d\dT\d\d:\d\d:\d\d.\d\d\d\d\d\d[+-]\d\d:\d\d {run_dir}/.config
                            > drwx------ .+ 0 \d\d\d\d-\d\d-\d\dT\d\d:\d\d:\d\d.\d\d\d\d\d\d[+-]\d\d:\d\d {run_dir}/.config/assimilate
                            > -rw------- .+ 37 \d\d\d\d-\d\d-\d\dT\d\d:\d\d:\d\d.\d\d\d\d\d\d[+-]\d\d:\d\d {run_dir}/.config/assimilate/shared.conf.nt
                            > -rw------- .+ 114 \d\d\d\d-\d\d-\d\dT\d\d:\d\d:\d\d.\d\d\d\d\d\d[+-]\d\d:\d\d {run_dir}/.config/assimilate/test.conf.nt
                            > -rw------- .+ 4000 \d\d\d\d-\d\d-\d\dT\d\d:\d\d:\d\d.\d\d\d\d\d\d[+-]\d\d:\d\d {run_dir}/a
                            > -rw------- .+ 400000 \d\d\d\d-\d\d-\d\dT\d\d:\d\d:\d\d.\d\d\d\d\d\d[+-]\d\d:\d\d {run_dir}/b
                            > -rw------- .+ 40000 \d\d\d\d-\d\d-\d\dT\d\d:\d\d:\d\d.\d\d\d\d\d\d[+-]\d\d:\d\d {run_dir}/c
                            > Total size = 444151B.

            surpass — list --name {{{2:
                run: assimilate list --name
                checks:
                    stderr:
                        matches regex: archive: .*

                    stdout:
                        matches text:
                            > {run_dir}
                            > {run_dir}/.config
                            > {run_dir}/.config/assimilate
                            > {run_dir}/.config/assimilate/shared.conf.nt
                            > {run_dir}/.config/assimilate/test.conf.nt
                            > {run_dir}/a
                            > {run_dir}/b
                            > {run_dir}/c

            scare — list --sort-by-name {{{2:
                run: assimilate list --sort-by-name
                checks:
                    stderr:
                        matches regex: archive: .*

                    stdout:
                        matches text:
                            > {run_dir}/
                            > {run_dir}/.config/
                            > {run_dir}/.config/assimilate/
                            > {run_dir}/.config/assimilate/shared.conf.nt
                            > {run_dir}/.config/assimilate/test.conf.nt
                            > {run_dir}/a
                            > {run_dir}/b
                            > {run_dir}/c

            evaporate — list --sort-by-date {{{2:
                run: assimilate list --sort-by-date
                checks:
                    stderr:
                        matches regex: archive: .*

                    stdout:
                        matches regex:
                            > \d\d\d\d-\d\d-\d\dT\d\d:\d\d:\d\d.\d\d\d\d\d\d[+-]\d\d:\d\d {run_dir}/.config/assimilate/shared.conf.nt
                            > \d\d\d\d-\d\d-\d\dT\d\d:\d\d:\d\d.\d\d\d\d\d\d[+-]\d\d:\d\d {run_dir}/.config/assimilate/test.conf.nt
                            > \d\d\d\d-\d\d-\d\dT\d\d:\d\d:\d\d.\d\d\d\d\d\d[+-]\d\d:\d\d {run_dir}/c
                            > \d\d\d\d-\d\d-\d\dT\d\d:\d\d:\d\d.\d\d\d\d\d\d[+-]\d\d:\d\d {run_dir}/b
                            > \d\d\d\d-\d\d-\d\dT\d\d:\d\d:\d\d.\d\d\d\d\d\d[+-]\d\d:\d\d {run_dir}/
                            > \d\d\d\d-\d\d-\d\dT\d\d:\d\d:\d\d.\d\d\d\d\d\d[+-]\d\d:\d\d {run_dir}/a
                            > \d\d\d\d-\d\d-\d\dT\d\d:\d\d:\d\d.\d\d\d\d\d\d[+-]\d\d:\d\d {run_dir}/.config/
                            > \d\d\d\d-\d\d-\d\dT\d\d:\d\d:\d\d.\d\d\d\d\d\d[+-]\d\d:\d\d {run_dir}/.config/assimilate/

            cataract — list --sort-by-size {{{2:
                run: assimilate list --sort-by-size
                checks:
                    stderr:
                        matches regex: archive: .*

                    stdout:
                        matches text:
                            >      0B {run_dir}/
                            >      0B {run_dir}/.config/
                            >      0B {run_dir}/.config/assimilate/
                            >     37B {run_dir}/.config/assimilate/shared.conf.nt
                            >    114B {run_dir}/.config/assimilate/test.conf.nt
                            > 3.91KiB {run_dir}/a
                            > 39.1KiB {run_dir}/c
                            >  391KiB {run_dir}/b
                            > Total size = 444151B.

            relegate — list --sort-by-size --reverse-sort {{{2:
                run: assimilate list --sort-by-size --reverse-sort
                checks:
                    stderr:
                        matches regex: archive: .*

                    stdout:
                        matches text:
                            >  391KiB {run_dir}/b
                            > 39.1KiB {run_dir}/c
                            > 3.91KiB {run_dir}/a
                            >    114B {run_dir}/.config/assimilate/test.conf.nt
                            >     37B {run_dir}/.config/assimilate/shared.conf.nt
                            >      0B {run_dir}/.config/assimilate/
                            >      0B {run_dir}/.config/
                            >      0B {run_dir}/
                            > Total size = 444151B.

            coquette — list --sort-by-owner {{{2:
                run: assimilate list --sort-by-owner
                checks:
                    stderr:
                        matches regex: archive: .*

                    stdout:
                        matches regex:
                            > .+ {run_dir}/
                            > .+ {run_dir}/.config/
                            > .+ {run_dir}/.config/assimilate/
                            > .+ {run_dir}/.config/assimilate/shared.conf.nt
                            > .+ {run_dir}/.config/assimilate/test.conf.nt
                            > .+ {run_dir}/a
                            > .+ {run_dir}/b
                            > .+ {run_dir}/c


            uniform — list --sort-by-group {{{2:
                run: assimilate list --sort-by-group
                checks:
                    stderr:
                        matches regex: archive: .*

                    stdout:
                        matches regex:
                            > .+ {run_dir}/
                            > .+ {run_dir}/.config/
                            > .+ {run_dir}/.config/assimilate/
                            > .+ {run_dir}/.config/assimilate/shared.conf.nt
                            > .+ {run_dir}/.config/assimilate/test.conf.nt
                            > .+ {run_dir}/a
                            > .+ {run_dir}/b
                            > .+ {run_dir}/c

            piggery — list --sort-by-key {{{2:
                run: assimilate list --sort-by-key size
                checks:
                    stderr:
                        matches regex: archive: .*

                    stdout:
                        matches text:
                            > {run_dir}/
                            > {run_dir}/.config/
                            > {run_dir}/.config/assimilate/
                            > {run_dir}/.config/assimilate/shared.conf.nt
                            > {run_dir}/.config/assimilate/test.conf.nt
                            > {run_dir}/a
                            > {run_dir}/c
                            > {run_dir}/b
                            > Total size = 444151B.

            coyote — list --format {{{2:
                run: assimilate list --format size
                checks:
                    stderr:
                        matches regex: archive: .*

                    stdout:
                        matches text:
                            >        0 {run_dir}/
                            >        0 {run_dir}/.config/
                            >        0 {run_dir}/.config/assimilate/
                            >       37 {run_dir}/.config/assimilate/shared.conf.nt
                            >      114 {run_dir}/.config/assimilate/test.conf.nt
                            >     4000 {run_dir}/a
                            >   400000 {run_dir}/b
                            >    40000 {run_dir}/c
                            > Total size = 444151B.

            sphere — list ❬path❭ {{{2:
                run: assimilate list .config

                checks:
                    stderr:
                        matches regex: archive: .*

                    stdout:
                        matches text:
                            > {run_dir}/.config/
                            > {run_dir}/.config/assimilate/

            yacht — list ❬path❭ {{{2:
                run: assimilate list --recursive .config

                checks:
                    stderr:
                        matches regex: archive: .*

                    stdout:
                        matches text:
                            > {run_dir}/.config/
                            > {run_dir}/.config/assimilate/
                            > {run_dir}/.config/assimilate/shared.conf.nt
                            > {run_dir}/.config/assimilate/test.conf.nt

            shoulder — list --show-formats {{{2:
                run: assimilate list --show-formats
                checks:
                    stdout:
                        matches text:
                            >      name: {{path}}
                            >     short: {{path}}{{Type}}
                            >      date: {{mtime}} {{path}}{{Type}}
                            >      size: {{size:8}} {{path}}{{Type}}
                            >        si: {{Size:7.2b}} {{path}}{{Type}}
                            >     owner: {{user:8}} {{path}}{{Type}}
                            >     group: {{group:8}} {{path}}{{Type}}
                            >      long: {{mode:10}} {{user:6}} {{group:6}} {{size:8}} {{mtime}} {{path}}{{extra}}
                            >
                            > default format: short

#  vim: set sw=4 sts=4 tw=999 fo=ntcqwa12jor et spell:
